<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080">
    <title>Résultats - Sondage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            width: 1920px;
            min-height: 1080px;
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }
        
        .container {
            width: fit-content;
            min-width: 500px;
            max-width: 1900px;
            min-height: auto;
            max-height: none;
            height: auto;
            background: linear-gradient(135deg, #0a1828 0%, #1a2f4a 50%, #0d2744 100%);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 30px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 4rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            line-height: 1.2;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        h1 .title-fr {
            color: #ffffff;
        }
        
        h1 .title-nl {
            color: #f4d03f;
        }

        /* Masquer les éléments NL si mode bilingue désactivé */
        body:not(.bilingual-mode) .title-nl,
        body:not(.bilingual-mode) .subtitle-nl,
        body:not(.bilingual-mode) .loading-nl {
            display: none;
        }

        /* Ajuster l'affichage du sous-titre en mode unilingue */
        body:not(.bilingual-mode) .subtitle {
            display: block;
        }
        
        /* Masquer les éléments NL si mode bilingue désactivé */
        body:not(.bilingual-mode) .title-nl,
        body:not(.bilingual-mode) .subtitle-nl,
        body:not(.bilingual-mode) .loading-nl {
            display: none;
        }

        .subtitle {
            font-size: 3.3rem;
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.4;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .subtitle .subtitle-fr {
            color: #ffffff;
        }
        
        .subtitle .subtitle-nl {
            color: #f4d03f;
        }
        
        /* Grille des résultats - adapte selon le nombre de résultats */
        .results-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 0;
            width: 100%;
            justify-content: center;
            align-items: flex-start;
        }

        /* Layout pour 2 résultats : côte à côte centrés */
        .results-grid.layout-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 1fr;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Layout pour 3 résultats : côte à côte centrés */
        .results-grid.layout-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: 1fr;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Layout pour 4 résultats : 2 colonnes de 2 */
        .results-grid.layout-4 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 1fr;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Layout pour 5 résultats : 2 colonnes de 2 + 1 centré en bas */
        .results-grid.layout-5 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 1fr;
            max-width: 1600px;
            margin: 0 auto;
        }

        .results-grid.layout-5 .player-result:nth-child(5) {
            grid-column: 1 / -1;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        /* Layout pour 6 résultats : 2 colonnes de 3 */
        .results-grid.layout-6 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 1fr;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Pour plus de 6 résultats : grille standard 3 colonnes */
        .results-grid.layout-default {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: 1fr;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .player-result {
            background: rgba(26, 47, 74, 0.6);
            border: 2px solid #d4af37;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }
        
        .player-result:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
            border-color: #f0d46f;
        }
        
        .player-result.first-place {
            border: 3px solid #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .player-result.first-place .rank-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .player-name-container {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            flex: 1;
            min-width: 0;
        }
        
        .rank-badge {
            background: linear-gradient(135deg, #d4af37, #f0d46f);
            color: #0a1828;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.6em;
            flex-shrink: 0;
        }
        
        .player-name-wrapper {
            flex: 1;
            min-width: 0;
        }
        
        .player-name {
            color: #ffffff;
            font-size: 1.8rem;
            font-weight: bold;
            word-break: break-word;
            line-height: 1.3;
            margin-bottom: 5px;
        }
        
        .player-name-nl {
            color: #f4d03f;
            font-size: 1.8rem;
            font-weight: bold;
            word-break: break-word;
            line-height: 1.3;
            font-style: italic;
        }
        
        .player-stats {
            text-align: right;
            flex-shrink: 0;
            margin-left: 15px;
        }
        
        .percentage {
            color: #d4af37;
            font-size: 2.2em;
            font-weight: bold;
        }
        
        .progress-bar-container {
            background: rgba(10, 24, 40, 0.7);
            border-radius: 8px;
            height: 25px;
            overflow: hidden;
            border: 1px solid rgba(212, 175, 55, 0.3);
            margin-top: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #f0d46f);
            border-radius: 8px;
            transition: width 0.8s ease;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }
        
        .progress-bar.first-place {
            background: linear-gradient(90deg, #FFD700, #FFA500);
        }
        
        .no-votes {
            text-align: center;
            color: #ffffff;
            padding: 40px;
            font-size: 1.3em;
            grid-column: 1 / -1;
        }
        
        .loading {
            text-align: center;
            color: #d4af37;
            font-size: 1.5em;
            padding: 40px;
        }
        
        .error-message {
            background: rgba(220, 53, 69, 0.2);
            border: 2px solid #dc3545;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="title-fr" id="surveyTitle">Résultats</span>
                <span class="title-nl" id="surveyTitleNl"></span>
            </h1>
            <div class="subtitle">
                <span class="subtitle-fr" id="surveyDescription">Classement</span>
                <span class="subtitle-nl" id="surveyDescriptionNl"></span>
            </div>
        </div>
        
        <div id="loadingMessage" class="loading">
            <span class="loading-fr">Chargement des résultats...</span>
            <span class="loading-nl"><br>Resultaten laden...</span>
        </div>
        
        <div id="resultsGrid" class="results-grid" style="display: none;"></div>
    </div>

    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let supabaseClient = null;
        let currentSurveyId = null;
        let refreshInterval = null;
        let isBilingualMode = false;
        let currentZoom = 1; // Mémoriser le zoom actuel

        // ============================================
        // URL PARAMETERS
        // ============================================
        async function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            let surveyId = urlParams.get('survey') || urlParams.get('id');

            // Si aucun ID n'est fourni dans l'URL, récupérer le sondage actif
            if (!surveyId) {
                console.log('🔍 Aucun ID dans l\'URL, recherche du sondage actif...');
                
                try {
                    // Initialiser Supabase si pas encore fait
                    if (!supabaseClient) {
                        if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
                            showError('Configuration manquante. Veuillez vérifier config.js');
                            return null;
                        }
                        supabaseClient = supabase.createClient(
                            window.SUPABASE_URL,
                            window.SUPABASE_ANON_KEY
                        );
                    }
                    
                    // Récupérer le sondage actif
                    const { data: activeSurvey, error } = await supabaseClient
                        .from('surveys')
                        .select('id')
                        .eq('active', true)
                        .maybeSingle();
                    
                    if (error) {
                        console.error('❌ Erreur récupération sondage actif:', error);
                        showError('Erreur lors de la récupération du sondage actif');
                        return null;
                    }
                    
                    if (!activeSurvey) {
                        showError('Aucun sondage actif pour le moment');
                        return null;
                    }
                    
                    surveyId = activeSurvey.id;
                    console.log('✅ Sondage actif trouvé:', surveyId);
                    
                } catch (error) {
                    console.error('❌ Erreur:', error);
                    showError('Erreur lors de la récupération du sondage actif');
                    return null;
                }
            }

            console.log('📊 Survey ID:', surveyId);
            return surveyId;
        }

        // ============================================
        // SUPABASE INITIALIZATION
        // ============================================
        async function initSupabase() {
            if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
                console.error('❌ Configuration Supabase manquante dans config.js');
                showError('Configuration manquante. Veuillez vérifier config.js');
                return false;
            }

            try {
                supabaseClient = supabase.createClient(
                    window.SUPABASE_URL,
                    window.SUPABASE_ANON_KEY
                );
                console.log('✅ Supabase initialisé');
                return true;
            } catch (error) {
                console.error('❌ Erreur lors de l\'initialisation de Supabase:', error);
                showError('Erreur de connexion à la base de données');
                return false;
            }
        }

        // ============================================
        // LOAD RESULTS
        // ============================================
        async function loadResults() {
            try {
                if (!supabaseClient || !currentSurveyId) {
                    console.error('❌ Supabase non initialisé ou survey_id manquant');
                    return;
                }

                console.log('🔄 Chargement des résultats pour le sondage:', currentSurveyId);

                // Vérifier le mode bilingue global depuis config_messages
                const { data: configData, error: configError } = await supabaseClient
                    .from('config_messages')
                    .select('bilingual_mode')
                    .single();

                const bilingualModeEnabled = configData?.bilingual_mode || false;
                console.log('🌐 Mode bilingue global:', bilingualModeEnabled);

                // Charger les informations du sondage (titre et description)
                const { data: surveyData, error: surveyError } = await supabaseClient
                    .from('surveys')
                    .select('titre, description')
                    .eq('id', currentSurveyId)
                    .single();

                if (surveyError) throw surveyError;

                // Afficher le titre et la description FR
                document.getElementById('surveyTitle').textContent = surveyData.titre || 'Résultats';
                document.getElementById('surveyDescription').textContent = surveyData.description || 'Classement';

                // Si mode bilingue, charger les traductions NL
                if (bilingualModeEnabled) {
                    const { data: translationData } = await supabaseClient
                        .from('survey_translations')
                        .select('titre, description')
                        .eq('survey_id', currentSurveyId)
                        .eq('language_code', 'nl')
                        .eq('active', true)
                        .maybeSingle();

                    if (translationData && translationData.titre) {
                        // Afficher les titres NL
                        document.getElementById('surveyTitleNl').textContent = translationData.titre;
                        
                        if (translationData.description) {
                            document.getElementById('surveyDescriptionNl').textContent = translationData.description;
                        }
                    }
                }

                // Récupérer les résultats déjà calculés depuis la vue
                const { data: resultsData, error: resultsError } = await supabaseClient
                    .from('v_survey_results')
                    .select('*')
                    .eq('survey_id', currentSurveyId)
                    .order('rank', { ascending: true });

                if (resultsError) throw resultsError;
                
                if (!resultsData || resultsData.length === 0) {
                    throw new Error('Aucun candidat trouvé pour ce sondage');
                }

                console.log('👥 Résultats trouvés:', resultsData.length);

                // Charger les traductions NL des candidats SI mode bilingue activé
                let translationsMap = {};
                if (bilingualModeEnabled) {
                    const playerIds = resultsData.map(r => r.player_id);
                    const { data: translations } = await supabaseClient
                        .from('survey_player_translations')
                        .select('player_id, nom')
                        .in('player_id', playerIds)
                        .eq('language_code', 'nl');

                    if (translations) {
                        translations.forEach(t => {
                            translationsMap[t.player_id] = t.nom;
                        });
                    }
                }

                // Mode bilingue actif SEULEMENT si le mode global est activé ET qu'il y a des traductions NL
                isBilingualMode = bilingualModeEnabled && Object.keys(translationsMap).length > 0;
                console.log('📊 Affichage bilingue:', isBilingualMode);

                // Ajouter ou retirer la classe bilingual-mode sur le body
                if (isBilingualMode) {
                    document.body.classList.add('bilingual-mode');
                } else {
                    document.body.classList.remove('bilingual-mode');
                }

                // Ajouter les traductions NL aux résultats
                const results = resultsData.map(r => ({
                    player_id: r.player_id,
                    player_name: r.player_name,
                    player_name_nl: translationsMap[r.player_id] || null,
                    total_votes: r.total_votes || 0,
                    votes_fr: r.votes_fr || 0,
                    votes_nl: r.votes_nl || 0,
                    percentage: 0 // Sera calculé dans displayResults
                }));

                // Calculer le total des votes
                const totalVotes = results.reduce((sum, r) => sum + r.total_votes, 0);
                const totalVotesFr = results.reduce((sum, r) => sum + r.votes_fr, 0);
                const totalVotesNl = results.reduce((sum, r) => sum + r.votes_nl, 0);

                console.log('📊 Résultats préparés:', results);

                // Afficher les résultats
                displayResults(results || [], totalVotes);

                // Masquer le loading et afficher les résultats
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('resultsGrid').style.display = 'grid';

                const totalPlayers = results.length;
                console.log(`📊 Résultats mis à jour : ${totalVotes} votes (${totalVotesFr} FR, ${totalVotesNl} NL), ${totalPlayers} candidats`);

            } catch (error) {
                console.error('❌ Erreur lors du chargement des résultats:', error);
                console.error('Details:', {
                    message: error.message,
                    code: error.code,
                    hint: error.hint,
                    details: error.details
                });
                
                let errorMessage = 'Erreur lors du chargement des résultats';
                
                if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                // Afficher des conseils selon le type d'erreur
                if (error.message && error.message.includes('permission denied')) {
                    errorMessage += '\n\n⚠️ Problème de permissions RLS. Exécutez le fichier SQL fourni dans Supabase.';
                } else if (error.message && error.message.includes('Aucun candidat')) {
                    errorMessage += '\n\n⚠️ Ajoutez des candidats au sondage #' + currentSurveyId;
                }
                
                showError(errorMessage);
            }
        }

        // ============================================
        // AUTO-SCALING WHEN CONTENT OVERFLOWS
        // ============================================
        function adjustContainerScale() {
            const container = document.querySelector('.container');
            
            if (!container) return;
            
            // Sauvegarder le zoom actuel (ou 1 si premier appel)
            if (currentZoom === 1) {
                // Premier appel: mesurer sans zoom
                requestAnimationFrame(() => {
                    const maxHeight = 1000;
                    const containerHeight = container.offsetHeight;
                    const totalHeight = containerHeight + 140; // avec ombre
                    
                    if (totalHeight > maxHeight) {
                        currentZoom = maxHeight / totalHeight;
                        container.style.zoom = currentZoom;
                        console.log(`🔽 Zoom initial: ${(currentZoom * 100).toFixed(1)}%`);
                    }
                });
            } else {
                // Appels suivants: le zoom est déjà appliqué, pas besoin de recalculer
                // (le contenu ne change pas de taille, juste les pourcentages)
                container.style.zoom = currentZoom;
            }
        }

        // ============================================
        // DISPLAY RESULTS
        // ============================================
        function displayResults(results, totalVotes) {
            const grid = document.getElementById('resultsGrid');
            
            if (!results || results.length === 0) {
                grid.innerHTML = '<div class="no-votes">Aucun candidat disponible</div>';
                return;
            }

            grid.innerHTML = '';

            // Limiter à 6 premiers résultats
            const topResults = results.slice(0, 6);

            // Appliquer le layout selon le nombre de résultats (comme dans survey)
            const numResults = topResults.length;
            grid.classList.remove('layout-2', 'layout-3', 'layout-4', 'layout-5', 'layout-6', 'layout-default');
            
            if (numResults === 2) {
                grid.classList.add('layout-2');
            } else if (numResults === 3) {
                grid.classList.add('layout-3');
            } else if (numResults === 4) {
                grid.classList.add('layout-4');
            } else if (numResults === 5) {
                grid.classList.add('layout-5');
            } else if (numResults === 6) {
                grid.classList.add('layout-6');
            } else {
                grid.classList.add('layout-default');
            }

            topResults.forEach((result, index) => {
                const votes = result.total_votes || 0;
                const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;
                const rank = index + 1;
                const isFirst = rank === 1;

                // Nettoyer le nom FR des emojis pour le mode bilingue
                let displayNameFr = result.player_name;
                let displayNameNl = result.player_name_nl;
                
                if (isBilingualMode && displayNameNl) {
                    // Enlever les emojis du nom NL (ils sont déjà dans le FR)
                    displayNameNl = removeEmojis(displayNameNl);
                }

                const card = document.createElement('div');
                card.className = 'player-result' + (isFirst ? ' first-place' : '');
                
                // Construction du HTML avec ou sans traduction NL
                let nameHtml = `<div class="player-name">${escapeHtml(displayNameFr)}</div>`;
                if (isBilingualMode && displayNameNl && displayNameNl.trim()) {
                    nameHtml += `<div class="player-name-nl">${escapeHtml(displayNameNl)}</div>`;
                }

                card.innerHTML = `
                    <div class="player-header">
                        <div class="player-name-container">
                            <div class="rank-badge">${rank}</div>
                            <div class="player-name-wrapper">
                                ${nameHtml}
                            </div>
                        </div>
                        <div class="player-stats">
                            <div class="percentage">${percentage}%</div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar ${isFirst ? 'first-place' : ''}" style="width: ${percentage}%"></div>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            // Ajuster l'échelle du container après l'affichage
            adjustContainerScale();
        }

        // ============================================
        // AUTO REFRESH
        // ============================================
        let surveyCheckInterval = null;
        
        async function checkForNewSurvey() {
            try {
                if (!supabaseClient) return;
                
                const { data: activeSurvey, error } = await supabaseClient
                    .from('surveys')
                    .select('id')
                    .eq('active', true)
                    .maybeSingle();
                
                // Si un nouveau sondage actif est détecté et différent du sondage actuel
                if (activeSurvey && activeSurvey.id !== currentSurveyId) {
                    console.log('Nouveau sondage actif detecte:', activeSurvey.id, '(ancien:', currentSurveyId, ')');
                    window.location.reload();
                }
            } catch (error) {
                console.error('Erreur lors de la verification du sondage actif:', error);
            }
        }
        
        function startAutoRefresh() {
            // Actualiser les résultats toutes les 2 secondes
            refreshInterval = setInterval(() => {
                loadResults();
            }, 2000);
            
            // Vérifier si un nouveau sondage est actif toutes les 5 secondes
            surveyCheckInterval = setInterval(checkForNewSurvey, 5000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            if (surveyCheckInterval) {
                clearInterval(surveyCheckInterval);
                surveyCheckInterval = null;
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('resultsGrid').style.display = 'grid';
            document.getElementById('resultsGrid').innerHTML = `<div class="error-message">${message}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function removeEmojis(text) {
            // Regex pour enlever les emojis
            return text.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        (async function init() {
            currentSurveyId = await getUrlParams();
            if (!currentSurveyId) return;

            const initialized = await initSupabase();
            if (initialized) {
                await loadResults();
                startAutoRefresh();
            }
        })();

        // Arrêter le rafraîchissement quand la page est masquée
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
