<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PNG ‚Üí APNG (Uniform Frames, Ensemble & Boucle)</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{background:#fff;border-radius:16px;padding:28px;max-width:900px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.3)}
h1{font-size:24px;margin:0 0 6px;color:#222;text-align:center}
.subtitle{text-align:center;color:#666;margin-bottom:18px;font-size:14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.section{padding:14px;background:#f8f9ff;border-radius:12px;border:2px solid #e0e4ff}
.section h3{font-size:15px;color:#667eea;margin-bottom:6px}
.section small{display:block;color:#666;margin-bottom:8px}
.upload-zone{border:2px dashed #667eea;border-radius:8px;padding:20px 10px;text-align:center;cursor:pointer;background:#fff}
.upload-zone.dragover{border-color:#764ba2;background:#f0f1ff}
.upload-zone.has-files{border-color:#4caf50;background:#f1f8f4}
.upload-count{color:#4caf50;font-size:13px;font-weight:600;margin-top:6px}
input[type=file]{display:none}
.row{display:flex;align-items:center;gap:10px;margin-top:8px}
.row .grow{flex:1}
input[type=number]{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;text-align:center}
.toggle{position:relative;width:50px;height:26px}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.3s;border-radius:26px}
.toggle-slider:before{content:"";position:absolute;height:18px;width:18px;left:4px;bottom:4px;background:#fff;transition:.3s;border-radius:50%}
.toggle input:checked+.toggle-slider{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
.toggle input:checked+.toggle-slider:before{transform:translateX(24px)}
.actions{display:flex;gap:10px;margin-top:14px}
button{flex:1;padding:12px 18px;border:none;border-radius:8px;font-weight:700;cursor:pointer}
.btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-secondary{background:#f0f0f0;color:#666}
.status{margin-top:12px;padding:12px;border-radius:8px;text-align:center;font-size:14px;display:none}
.status.show{display:block}
.status.info{background:#e3f2fd;color:#1976d2}
.status.success{background:#e8f5e9;color:#388e3c}
.status.error{background:#ffebee;color:#c62828}
.progress{margin-top:10px;height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden;display:none}
.progress.show{display:block}
.progress-bar{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);width:0;transition:width .25s linear}
pre{background:#f7f7f7;border:1px solid #eee;padding:10px;border-radius:6px;white-space:pre-wrap;font-size:12px;color:#333;max-height:200px;overflow:auto}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef;border:1px solid #ccd;color:#556;font-size:12px;margin-left:6px}
</style>
</head>
<body>
<div class="container">
  <h1>üéûÔ∏è PNG ‚Üí APNG</h1>
  <p class="subtitle">Frames uniformes, ensemble & boucle fiables</p>

  <div class="grid">
    <div class="section">
      <h3>1) Animation d‚Äôentr√©e <span class="badge">obligatoire</span></h3>
      <small>Uploadez vos PNG (tri√©s par nom). Tous les frames seront forc√©s √† la m√™me taille que la <b>1 ≥·µâ image</b>.</small>
      <div class="upload-zone" id="zoneIntro"><div>üìÅ Glissez / Cliquez</div></div>
      <input type="file" id="inputIntro" accept="image/png" multiple>
      <div class="upload-count" id="countIntro"></div>
    </div>

    <div class="section">
      <h3>2) Pause (freeze) <span class="badge">temps uniquement</span></h3>
      <small>On fige automatiquement la <b>derni√®re image de l‚Äôintro</b> (aucun upload).</small>
      <div class="row">
        <div class="grow"><input id="freezeSec" type="number" min="0" max="3600" step="0.5" value="0"></div>
        <div>sec</div>
      </div>
      <small>Si 0 ‚Üí ignor√©.</small>
    </div>

    <div class="section">
      <h3>3) Animation de sortie <span class="badge">optionnel</span></h3>
      <small>Uploadez vos PNG d‚Äôoutro (tri√©s par nom). Seront redimensionn√©s √† la taille de l‚Äôintro.</small>
      <div class="upload-zone" id="zoneOutro"><div>üìÅ Glissez / Cliquez</div></div>
      <input type="file" id="inputOutro" accept="image/png" multiple>
      <div class="upload-count" id="countOutro"></div>
    </div>

    <div class="section">
      <h3>Options</h3>
      <div class="row">
        <div class="grow">
          <label>FPS</label>
          <input id="fps" type="number" min="1" max="120" step="1" value="50">
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <label>Boucle infinie</label>
          <label class="toggle">
            <input type="checkbox" id="loop" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <div class="actions">
    <button class="btn" id="btnConvert" disabled>Cr√©er APNG</button>
    <button class="btn-secondary" id="btnClear">Effacer</button>
  </div>

  <div class="progress" id="progress"><div class="progress-bar" id="bar"></div></div>
  <div class="status" id="status"></div>
  <div style="margin-top:12px">
    <details><summary>Journal technique</summary>
      <pre id="log"></pre>
    </details>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
<script>
// ---------- Utils ----------
function log(msg){const el=document.getElementById('log'); el.textContent += msg + "\\n";}
function showStatus(msg,type){const el=document.getElementById('status'); el.textContent=msg; el.className='status show '+type;}
function hideStatus(){document.getElementById('status').classList.remove('show');}
function showProgress(){document.getElementById('progress').classList.add('show');}
function hideProgress(){document.getElementById('progress').classList.remove('show'); document.getElementById('bar').style.width='0';}
function updateProgress(p){document.getElementById('bar').style.width=p+'%';}

function setApngNumPlays(buf, plays){
  const bytes=new Uint8Array(buf); let p=8;
  const readU32=(o)=>(bytes[o]<<24)|(bytes[o+1]<<16)|(bytes[o+2]<<8)|bytes[o+3];
  const writeU32=(o,v)=>{bytes[o]=v>>>24; bytes[o+1]=(v>>>16)&255; bytes[o+2]=(v>>>8)&255; bytes[o+3]=v&255;};
  const table=(()=>{let t=[],c;for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); t[n]=c>>>0;}return t;})();
  const crc32=(arr)=>{let c=~0; for(let i=0;i<arr.length;i++) c=(c>>>8)^table[(c^arr[i])&255]; return (~c)>>>0;};
  while(p<bytes.length){
    const len=readU32(p);
    const type=String.fromCharCode(bytes[p+4],bytes[p+5],bytes[p+6],bytes[p+7]);
    if(type==='acTL'){
      writeU32(p+8+4, plays);
      const start=p+4, end=p+8+len;
      const newCrc=crc32(bytes.slice(start,end));
      writeU32(end,newCrc);
      return bytes.buffer;
    }
    p+=12+len;
  }
  return buf;
}
function getApngNumPlays(buf){
  const bytes=new Uint8Array(buf); let p=8;
  const readU32=(o)=>(bytes[o]<<24)|(bytes[o+1]<<16)|(bytes[o+2]<<8)|bytes[o+3];
  while(p<bytes.length){
    const len=readU32(p);
    const type=String.fromCharCode(bytes[p+4],bytes[p+5],bytes[p+6],bytes[p+7]);
    if(type==='acTL'){ return readU32(p+8+4)>>>0; }
    p+=12+len;
  }
  return null;
}

// ---------- DOM ----------
const zoneIntro=document.getElementById('zoneIntro');
const inputIntro=document.getElementById('inputIntro');
const countIntro=document.getElementById('countIntro');
const zoneOutro=document.getElementById('zoneOutro');
const inputOutro=document.getElementById('inputOutro');
const countOutro=document.getElementById('countOutro');
const freezeSec=document.getElementById('freezeSec');
const fpsInput=document.getElementById('fps');
const loop=document.getElementById('loop');
const btnConvert=document.getElementById('btnConvert');
const btnClear=document.getElementById('btnClear');

function setupZone(zoneEl, inputEl, onFiles){
  zoneEl.addEventListener('click',()=>inputEl.click());
  zoneEl.addEventListener('dragover',e=>{e.preventDefault(); zoneEl.classList.add('dragover');});
  zoneEl.addEventListener('dragleave',()=>zoneEl.classList.remove('dragover'));
  zoneEl.addEventListener('drop',e=>{e.preventDefault(); zoneEl.classList.remove('dragover'); onFiles(e.dataTransfer.files);});
  inputEl.addEventListener('change',e=>onFiles(e.target.files));
}

function sortPngs(files){return [...files].filter(f=>f.type==='image/png').sort((a,b)=>a.name.localeCompare(b.name));}

let introFiles=[], outroFiles=[];
let targetW=0, targetH=0;

setupZone(zoneIntro, inputIntro, files=>{
  introFiles=sortPngs(files);
  if(introFiles.length){
    zoneIntro.classList.add('has-files');
    countIntro.textContent='‚úì '+introFiles.length+' image'+(introFiles.length>1?'s':'')+' s√©lectionn√©e'+(introFiles.length>1?'s':'');
  } else {
    zoneIntro.classList.remove('has-files'); countIntro.textContent='';
  }
  btnConvert.disabled = introFiles.length===0;
});
setupZone(zoneOutro, inputOutro, files=>{
  outroFiles=sortPngs(files);
  if(outroFiles.length){
    zoneOutro.classList.add('has-files');
    countOutro.textContent='‚úì '+outroFiles.length+' image'+(outroFiles.length>1?'s':'')+' s√©lectionn√©e'+(outroFiles.length>1?'s':'');
  } else {
    zoneOutro.classList.remove('has-files'); countOutro.textContent='';
  }
});

btnClear.onclick=()=>{
  introFiles=[]; outroFiles=[];
  inputIntro.value=''; inputOutro.value='';
  zoneIntro.classList.remove('has-files'); countIntro.textContent='';
  zoneOutro.classList.remove('has-files'); countOutro.textContent='';
  freezeSec.value='0'; fpsInput.value='50'; loop.checked=true;
  btnConvert.disabled=true; hideStatus(); hideProgress(); document.getElementById('log').textContent='';
};

btnConvert.onclick=async ()=>{
  if(!introFiles.length){ showStatus('‚ùå Ajoutez au moins une image d‚Äôintro.', 'error'); return; }
  showStatus('Pr√©paration des frames (uniformisation)‚Ä¶', 'info'); showProgress(); document.getElementById('log').textContent='';

  try{
    const fps=Math.min(120, Math.max(1, parseInt(fpsInput.value,10) || 50));
    const delayPer=Math.round(1000/fps);
    const freezeMs=Math.max(0, Math.round(parseFloat(freezeSec.value||'0')*1000));
    const hasFreeze = freezeMs>0;

    const frames=[], delays=[];
    let total=0;

    // 1) Charger la 1√®re image pour d√©finir la taille cible
    const first = await loadImage(introFiles[0]);
    targetW = first.width; targetH = first.height;
    frames.push(first.buffer); delays.push(delayPer); total++;
    log(`Frame #${total}: ${targetW}x${targetH} (r√©f√©rence)`);

    // 2) Intro suite: redessiner toutes les autres images sur un canvas de taille cible (uniformisation)
    for (let i=1; i<introFiles.length; i++){
      const img = await loadImage(introFiles[i]);
      const buf = drawToTarget(img, targetW, targetH);
      frames.push(buf); delays.push(delayPer); total++;
      log(`Frame #${total}: source=${img.width}x${img.height} -> target=${targetW}x${targetH}`);
      updateProgress(Math.min(90, total/(introFiles.length + (hasFreeze?1:0) + outroFiles.length)*100));
    }

    // 3) Freeze : dupliquer le DERNIER frame (d√©j√† en taille cible)
    if(hasFreeze){
      frames.push(frames[frames.length-1]); delays.push(freezeMs); total++;
      log(`Frame #${total}: freeze ${freezeMs}ms (duplique dernier frame)`);
    }

    // 4) Outro : uniformiser de la m√™me fa√ßon
    for (let i=0; i<outroFiles.length; i++){
      const img = await loadImage(outroFiles[i]);
      const buf = drawToTarget(img, targetW, targetH);
      frames.push(buf); delays.push(delayPer); total++;
      log(`Frame #${total}: OUTRO source=${img.width}x${img.height} -> target=${targetW}x${targetH}`);
    }

    // Encodage APNG
    showStatus('Encodage APNG‚Ä¶', 'info'); await new Promise(r=>setTimeout(r,30));
    let apng = UPNG.encode(frames, targetW, targetH, 256, delays);
    apng = setApngNumPlays(apng, loop.checked?0:1);
    const numPlays = getApngNumPlays(apng);
    log(`acTL.num_plays = ${numPlays}`);

    const blob = new Blob([apng], {type:'image/apng'});
    triggerDownload(blob, 'animation.apng');
    const ensemble = hasFreeze ? (outroFiles.length? '1+2+3' : '1+2') : (outroFiles.length? '1+3' : '1');
    showStatus(`‚úÖ APNG cr√©√© ‚Äî ${targetW}x${targetH}, frames=${total}, ensemble=${ensemble}, boucle=${loop.checked?'ON':'OFF'}, num_plays=${numPlays}`, 'success');
    hideProgress();
  }catch(e){
    console.error(e);
    showStatus('‚ùå Erreur : '+(e&&e.message||e), 'error');
    hideProgress();
  }
};

function drawToTarget(img, W, H){
  const c=document.createElement('canvas'); c.width=W; c.height=H;
  const ctx=c.getContext('2d');
  ctx.clearRect(0,0,W,H);
  // Dessin "fit" dans la cible en conservant le ratio, centr√© (letterbox)
  const scale=Math.min(W/img.width, H/img.height);
  const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
  const x=Math.round((W-w)/2), y=Math.round((H-h)/2);
  ctx.drawImage(img.element, x, y, w, h);
  const imageData = ctx.getImageData(0,0,W,H);
  return imageData.data.buffer;
}

function loadImage(file){
  return new Promise((resolve,reject)=>{
    const img=new Image(), rdr=new FileReader();
    rdr.onload=e=>{img.onload=()=>{
      const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
      const imageData=ctx.getImageData(0,0,c.width,c.height);
      resolve({buffer:imageData.data.buffer, width:c.width, height:c.height, element:img});
    }; img.onerror=()=>reject(new Error('Image invalide')); img.src=e.target.result;};
    rdr.onerror=()=>reject(new Error('Lecture fichier √©chou√©e'));
    rdr.readAsDataURL(file);
  });
}

function triggerDownload(blob, name){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
  setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);},100);
}
</script>
</body>
</html>
