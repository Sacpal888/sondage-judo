<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PNG ‚Üí APNG (Ensemble & Boucle exacts)</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{background:#fff;border-radius:16px;padding:32px;max-width:820px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.3)}
h1{font-size:26px;color:#333;margin-bottom:6px;text-align:center}
.subtitle{text-align:center;color:#666;margin-bottom:22px;font-size:14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.section{padding:16px;background:#f8f9ff;border-radius:12px;border:2px solid #e0e4ff}
.section h3{font-size:15px;color:#667eea;margin-bottom:8px}
.section small{display:block;color:#666;margin-bottom:10px}
.upload-zone{border:2px dashed #667eea;border-radius:8px;padding:24px 12px;text-align:center;cursor:pointer;background:#fff}
.upload-zone.dragover{border-color:#764ba2;background:#f0f1ff}
.upload-zone.has-files{border-color:#4caf50;background:#f1f8f4}
.upload-count{color:#4caf50;font-size:13px;font-weight:600;margin-top:8px}
input[type=file]{display:none}
.row{display:flex;align-items:center;gap:10px;margin-top:8px}
.row .grow{flex:1}
input[type=number]{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;text-align:center}
.toggle{position:relative;width:50px;height:26px}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.3s;border-radius:26px}
.toggle-slider:before{content:"";position:absolute;height:18px;width:18px;left:4px;bottom:4px;background:#fff;transition:.3s;border-radius:50%}
.toggle input:checked+.toggle-slider{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
.toggle input:checked+.toggle-slider:before{transform:translateX(24px)}
.actions{display:flex;gap:10px;margin-top:16px}
button{flex:1;padding:12px 18px;border:none;border-radius:8px;font-weight:700;cursor:pointer}
.btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-secondary{background:#f0f0f0;color:#666}
.status{margin-top:14px;padding:12px;border-radius:8px;text-align:center;font-size:14px;display:none}
.status.show{display:block}
.status.info{background:#e3f2fd;color:#1976d2}
.status.success{background:#e8f5e9;color:#388e3c}
.status.error{background:#ffebee;color:#c62828}
.progress{margin-top:10px;height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden;display:none}
.progress.show{display:block}
.progress-bar{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);width:0;transition:width .25s linear}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef;border:1px solid #ccd;color:#556;font-size:12px;margin-left:6px}
.hint{font-size:12px;color:#555;margin-top:6px}
</style>
</head>
<body>
<div class="container">
  <h1>üéûÔ∏è PNG ‚Üí APNG</h1>
  <p class="subtitle">Boucle appliqu√©e √† l‚Äô<b>ensemble</b> d√©tect√© automatiquement</p>

  <div class="grid">
    <div class="section">
      <h3>1) Animation d‚Äôentr√©e <span class="badge">obligatoire</span></h3>
      <small>Uploadez vos PNG d‚Äôintro (tri√©s par nom)</small>
      <div class="upload-zone" id="zoneIntro"><div>üìÅ Glissez / Cliquez</div></div>
      <input type="file" id="inputIntro" accept="image/png" multiple>
      <div class="upload-count" id="countIntro"></div>
      <div class="hint">Sans intro ‚Üí pas d‚Äôensemble ‚Üí pas d‚ÄôAPNG</div>
    </div>

    <div class="section">
      <h3>2) Pause (freeze) <span class="badge">temps seul</span></h3>
      <small>Aucune image √† uploader. On fige <b>la derni√®re image de l‚Äôintro</b> pendant X secondes.</small>
      <div class="row">
        <div class="grow"><input id="freezeSec" type="number" min="0" max="3600" step="0.5" value="0"></div>
        <div>sec</div>
      </div>
      <div class="hint">Si 0 ‚Üí ignor√© (n‚Äôentre pas dans l‚Äôensemble)</div>
    </div>

    <div class="section">
      <h3>3) Animation de sortie <span class="badge">optionnel</span></h3>
      <small>Uploadez vos PNG d‚Äôoutro (tri√©s par nom)</small>
      <div class="upload-zone" id="zoneOutro"><div>üìÅ Glissez / Cliquez</div></div>
      <input type="file" id="inputOutro" accept="image/png" multiple>
      <div class="upload-count" id="countOutro"></div>
    </div>

    <div class="section">
      <h3>Options</h3>
      <small>La boucle s‚Äôapplique √† l‚Äô<b>ensemble</b> d√©tect√© (1 / 1+2 / 1+2+3)</small>
      <div class="row">
        <div class="grow">
          <label>FPS</label>
          <input id="fps" type="number" min="1" max="120" step="1" value="50">
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <label>Boucle infinie</label>
          <label class="toggle">
            <input type="checkbox" id="loop" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="hint">D√©cochez pour lecture unique de l‚Äôensemble.</div>
    </div>
  </div>

  <div class="actions">
    <button class="btn" id="btnConvert" disabled>Cr√©er APNG</button>
    <button class="btn-secondary" id="btnClear">Effacer</button>
  </div>

  <div class="progress" id="progress"><div class="progress-bar" id="bar"></div></div>
  <div class="status" id="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
<script>
// ========== Utilitaires ==========
function showStatus(msg,type){const el=document.getElementById('status'); el.textContent=msg; el.className='status show '+type;}
function hideStatus(){document.getElementById('status').classList.remove('show');}
function showProgress(){document.getElementById('progress').classList.add('show');}
function hideProgress(){document.getElementById('progress').classList.remove('show'); document.getElementById('bar').style.width='0';}
function updateProgress(p){document.getElementById('bar').style.width=p+'%';}

// Patch & read acTL.num_plays
function setApngNumPlays(buf, plays){
  const bytes=new Uint8Array(buf); let p=8;
  const readU32=(o)=>(bytes[o]<<24)|(bytes[o+1]<<16)|(bytes[o+2]<<8)|bytes[o+3];
  const writeU32=(o,v)=>{bytes[o]=v>>>24; bytes[o+1]=(v>>>16)&255; bytes[o+2]=(v>>>8)&255; bytes[o+3]=v&255;};
  const table=(()=>{let t=[],c;for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); t[n]=c>>>0;}return t;})();
  const crc32=(arr)=>{let c=~0; for(let i=0;i<arr.length;i++) c=(c>>>8)^table[(c^arr[i])&255]; return (~c)>>>0;};
  while(p<bytes.length){
    const len=readU32(p);
    const type=String.fromCharCode(bytes[p+4],bytes[p+5],bytes[p+6],bytes[p+7]);
    if(type==='acTL'){
      writeU32(p+8+4, plays);
      const start=p+4, end=p+8+len;
      const newCrc=crc32(bytes.slice(start,end));
      writeU32(end,newCrc);
      return bytes.buffer;
    }
    p+=12+len;
  }
  return buf;
}
function getApngNumPlays(buf){
  const bytes=new Uint8Array(buf); let p=8;
  const readU32=(o)=>(bytes[o]<<24)|(bytes[o+1]<<16)|(bytes[o+2]<<8)|bytes[o+3];
  while(p<bytes.length){
    const len=readU32(p);
    const type=String.fromCharCode(bytes[p+4],bytes[p+5],bytes[p+6],bytes[p+7]);
    if(type==='acTL'){
      return readU32(p+8+4)>>>0;
    }
    p+=12+len;
  }
  return null;
}

// Lecture fichiers
function setupZone(zoneEl, inputEl, onFiles){
  zoneEl.addEventListener('click',()=>inputEl.click());
  zoneEl.addEventListener('dragover',e=>{e.preventDefault(); zoneEl.classList.add('dragover');});
  zoneEl.addEventListener('dragleave',()=>zoneEl.classList.remove('dragover'));
  zoneEl.addEventListener('drop',e=>{e.preventDefault(); zoneEl.classList.remove('dragover'); onFiles(e.dataTransfer.files);});
  inputEl.addEventListener('change',e=>onFiles(e.target.files));
}
function sortPngs(files){return [...files].filter(f=>f.type==='image/png').sort((a,b)=>a.name.localeCompare(b.name));}

async function loadImageData(file){
  return new Promise((resolve,reject)=>{
    const img=new Image(), rdr=new FileReader();
    rdr.onload=e=>{img.onload=()=>{
      const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
      const imageData=ctx.getImageData(0,0,c.width,c.height);
      resolve({buffer:imageData.data.buffer, width:c.width, height:c.height});
    }; img.onerror=()=>reject(new Error('Image invalide')); img.src=e.target.result;};
    rdr.onerror=()=>reject(new Error('Lecture fichier √©chou√©e'));
    rdr.readAsDataURL(file);
  });
}
function triggerDownload(blob, name){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
  setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);},100);
}

// ========== √âtat ==========
let introFiles=[], outroFiles=[];

const zoneIntro=document.getElementById('zoneIntro');
const inputIntro=document.getElementById('inputIntro');
const countIntro=document.getElementById('countIntro');

const zoneOutro=document.getElementById('zoneOutro');
const inputOutro=document.getElementById('inputOutro');
const countOutro=document.getElementById('countOutro');

const freezeSec=document.getElementById('freezeSec');
const fpsInput=document.getElementById('fps');
const loop=document.getElementById('loop');

const btnConvert=document.getElementById('btnConvert');
const btnClear=document.getElementById('btnClear');

setupZone(zoneIntro, inputIntro, files=>{
  introFiles=sortPngs(files);
  if(introFiles.length){zoneIntro.classList.add('has-files'); countIntro.textContent='‚úì '+introFiles.length+' image'+(introFiles.length>1?'s':'')+' s√©lectionn√©e'+(introFiles.length>1?'s':'');}
  else {zoneIntro.classList.remove('has-files'); countIntro.textContent='';}
  btnConvert.disabled = introFiles.length===0;
});
setupZone(zoneOutro, inputOutro, files=>{
  outroFiles=sortPngs(files);
  if(outroFiles.length){zoneOutro.classList.add('has-files'); countOutro.textContent='‚úì '+outroFiles.length+' image'+(outroFiles.length>1?'s':'')+' s√©lectionn√©e'+(outroFiles.length>1?'s':'');}
  else {zoneOutro.classList.remove('has-files'); countOutro.textContent='';}
});

btnClear.onclick=()=>{
  introFiles=[]; outroFiles=[];
  inputIntro.value=''; inputOutro.value='';
  zoneIntro.classList.remove('has-files'); countIntro.textContent='';
  zoneOutro.classList.remove('has-files'); countOutro.textContent='';
  freezeSec.value='0'; fpsInput.value='50'; loop.checked=true;
  btnConvert.disabled=true; hideStatus(); hideProgress();
};

btnConvert.onclick=async ()=>{
  if(introFiles.length===0){ showStatus('‚ùå Aucun ensemble : uploadez au moins l‚Äôintro (section 1).', 'error'); return; }

  // D√©tection de l'ensemble
  const freezeMs = Math.max(0, parseFloat(freezeSec.value||'0')*1000);
  const hasFreeze = freezeMs > 0;
  const hasOutro = outroFiles.length > 0;
  let ensembleType = '1';              // intro seule
  if(hasFreeze) ensembleType = '1+2';   // intro + freeze
  if(hasOutro) ensembleType = hasFreeze ? '1+2+3' : '1+3'; // mais "1+3" n'est pas list√© par vous; on roulera quand m√™me

  showStatus(`Pr√©paration de l‚Äôensemble (${ensembleType})‚Ä¶`, 'info');
  showProgress();

  try{
    const frames=[], delays=[];
    const fps = Math.min(120, Math.max(1, parseInt(fpsInput.value,10) || 50));
    const delayPer = 1000 / fps;
    let width=0, height=0, total=0;

    // 1) Intro (obligatoire)
    for(const f of introFiles){
      const img=await loadImageData(f);
      if(total===0){width=img.width; height=img.height;}
      frames.push(img.buffer); delays.push(delayPer); total++;
      updateProgress(Math.min(95, total/(introFiles.length + (hasFreeze?1:0) + outroFiles.length)*100));
    }

    // 2) Freeze = tenir la DERNI√àRE image de l‚Äôintro (pas d‚Äôupload)
    if(hasFreeze){
      const last = frames[frames.length-1];
      frames.push(last); delays.push(freezeMs); total++;
    }

    // 3) Outro (optionnel)
    if(hasOutro){
      for(const f of outroFiles){
        const img=await loadImageData(f);
        frames.push(img.buffer); delays.push(delayPer); total++;
      }
    }

    // Encodage
    showStatus('Encodage APNG‚Ä¶', 'info');
    await new Promise(r=>setTimeout(r,30));
    let apng = UPNG.encode(frames, width, height, 256, delays);

    // Appliquer la boucle √† l'ENSEMBLE
    apng = setApngNumPlays(apng, loop.checked ? 0 : 1);
    const effective = getApngNumPlays(apng);

    const blob = new Blob([apng], {type:'image/apng'});
    triggerDownload(blob, 'animation.apng');

    const comp = [`intro:${introFiles.length}`, hasFreeze?`freeze:${(freezeMs/1000)}s`:null, hasOutro?`outro:${outroFiles.length}`:null].filter(Boolean).join(' + ');
    showStatus(`‚úÖ APNG cr√©√© ‚Äî Ensemble ${ensembleType} | ${width}x${height}px | frames=${total} | num_plays=${effective} | boucle=${loop.checked?'ON':'OFF'} | ${comp}`, 'success');
    hideProgress();
  }catch(e){
    console.error(e);
    showStatus('‚ùå Erreur : '+(e&&e.message||e), 'error');
    hideProgress();
  }
};
</script>
</body>
</html>
