<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Administration - Système de Vote Multi-Sondages</title>
 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
 <script src="config.js"></script>
 <style>
 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }
 
 body {
 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
 min-height: 100vh;
 padding: 20px;
 }

 /* ========================================
 LOADING SCREEN
 ======================================== */
 #authLoading {
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
 display: flex;
 flex-direction: column;
 justify-content: center;
 align-items: center;
 z-index: 10000;
 }

 #authLoading .spinner {
 border: 5px solid rgba(255, 255, 255, 0.3);
 border-top: 5px solid #ffffff;
 border-radius: 50%;
 width: 60px;
 height: 60px;
 animation: spin 1s linear infinite;
 margin-bottom: 20px;
 }

 @keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
 }

 #authLoading p {
 color: #ffffff;
 font-size: 1.2rem;
 }

 #mainContent {
 display: none;
 }

 #mainContent.show {
 display: block;
 }
 
 .container {
 max-width: 1400px;
 margin: 0 auto;
 }
 
 .header {
 background: white;
 padding: 30px;
 border-radius: 15px;
 margin-bottom: 30px;
 box-shadow: 0 10px 30px rgba(0,0,0,0.2);
 display: flex;
 justify-content: space-between;
 align-items: center;
 flex-wrap: wrap;
 gap: 20px;
 }
 
 .header h1 {
 color: #667eea;
 font-size: 32px;
 }
 
 .user-info-container {
 display: flex;
 align-items: center;
 gap: 15px;
 }
 
 .user-email {
 color: #666;
 font-size: 14px;
 }
 
 .logout-btn {
 background: #dc3545;
 color: white;
 border: none;
 padding: 10px 20px;
 border-radius: 8px;
 cursor: pointer;
 font-size: 14px;
 font-weight: 600;
 transition: all 0.3s;
 }
 
 .logout-btn:hover {
 background: #c82333;
 transform: translateY(-2px);
 }
 
 .section {
 background: white;
 padding: 30px;
 border-radius: 15px;
 margin-bottom: 30px;
 box-shadow: 0 10px 30px rgba(0,0,0,0.2);
 }
 
 .section h2 {
 color: #667eea;
 margin-bottom: 20px;
 font-size: 24px;
 }

 /* ========================================
 SURVEYS GRID
 ======================================== */
 .surveys-grid {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
 gap: 25px;
 margin-bottom: 30px;
 }

 .survey-card {
 background: rgba(102, 126, 234, 0.05);
 border: 2px solid rgba(102, 126, 234, 0.2);
 border-radius: 15px;
 padding: 25px;
 transition: all 0.3s ease;
 position: relative;
 }

 .survey-card:hover {
 transform: translateY(-5px);
 box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
 }

 .survey-card.active {
 border: 3px solid #667eea;
 background: rgba(102, 126, 234, 0.1);
 box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
 }

 .survey-order {
 position: absolute;
 top: 10px;
 right: 10px;
 background: rgba(102, 126, 234, 0.8);
 color: white;
 width: 35px;
 height: 35px;
 border-radius: 50%;
 display: flex;
 align-items: center;
 justify-content: center;
 font-weight: bold;
 font-size: 1.1rem;
 }

 .survey-header {
 display: flex;
 justify-content: space-between;
 align-items: flex-start;
 margin-bottom: 15px;
 gap: 15px;
 }

 .survey-title {
 font-size: 1.4rem;
 font-weight: bold;
 color: #667eea;
 flex: 1;
 padding-right: 40px;
 }

 .active-badge {
 background: #28a745;
 color: white;
 padding: 5px 15px;
 border-radius: 20px;
 font-size: 0.85rem;
 font-weight: bold;
 white-space: nowrap;
 }

 .inactive-badge {
 background: #666;
 color: white;
 padding: 5px 15px;
 border-radius: 20px;
 font-size: 0.85rem;
 font-weight: bold;
 white-space: nowrap;
 }

 .ever-activated-badge {
 background: #17a2b8;
 color: white;
 padding: 5px 15px;
 border-radius: 20px;
 font-size: 0.75rem;
 font-weight: bold;
 white-space: nowrap;
 cursor: help;
 }

 .ever-activated-badge-inactive {
 background: #ccc;
 color: #999;
 padding: 5px 15px;
 border-radius: 20px;
 font-size: 0.75rem;
 font-weight: bold;
 white-space: nowrap;
 cursor: help;
 opacity: 0.6;
 }

 .survey-description {
 color: #666;
 font-size: 0.9rem;
 margin-bottom: 15px;
 line-height: 1.4;
 }

 .survey-stats {
 display: flex;
 gap: 20px;
 margin: 15px 0;
 padding: 10px;
 background: rgba(102, 126, 234, 0.05);
 border-radius: 8px;
 }

 .survey-stat {
 display: flex;
 flex-direction: column;
 align-items: center;
 }

 .stat-value {
 font-size: 1.5rem;
 font-weight: bold;
 color: #667eea;
 }

 .stat-label {
 font-size: 0.75rem;
 color: #666;
 text-transform: uppercase;
 }

 .language-badges {
 display: flex;
 gap: 10px;
 margin: 10px 0;
 }

 .lang-badge {
 padding: 5px 12px;
 border-radius: 15px;
 font-size: 0.8rem;
 font-weight: 600;
 display: flex;
 align-items: center;
 gap: 5px;
 }

 .lang-badge.fr {
 background: rgba(0, 85, 164, 0.1);
 color: #0055a4;
 border: 1px solid #0055a4;
 }

 .lang-badge.nl {
 background: rgba(255, 108, 17, 0.1);
 color: #ff6c11;
 border: 1px solid #ff6c11;
 }

 .lang-badge.inactive {
 opacity: 0.4;
 text-decoration: line-through;
 }

 .survey-actions {
 display: flex;
 gap: 10px;
 flex-wrap: wrap;
 margin-top: 15px;
 }

 .survey-actions button {
 flex: 1;
 min-width: 120px;
 padding: 10px 15px;
 font-size: 0.85rem;
 }

 .btn {
 background: #667eea;
 color: white;
 border: none;
 padding: 12px 30px;
 border-radius: 8px;
 font-size: 16px;
 font-weight: 600;
 cursor: pointer;
 transition: all 0.3s;
 margin: 5px;
 }
 
 .btn:hover {
 background: #5568d3;
 transform: translateY(-2px);
 }

 .btn-success {
 background: #28a745;
 }

 .btn-success:hover {
 background: #218838;
 }

 .btn-danger {
 background: #dc3545;
 }

 .btn-danger:hover {
 background: #c82333;
 }

 .btn-warning {
 background: #ffc107;
 color: #333;
 }

 .btn-warning:hover {
 background: #e0a800;
 }

 .btn-info {
 background: #17a2b8;
 }

 .btn-info:hover {
 background: #138496;
 }

 .btn-done {
 background: #6c757d;
 color: white;
 }

 .btn-done:hover {
 background: #5a6268;
 }

 .btn-done.active {
 background: #28a745;
 }

 .btn-done.active:hover {
 background: #218838;
 }

 /* ========================================
 MODAL
 ======================================== */
 .modal {
 display: none;
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background: rgba(0, 0, 0, 0.7);
 z-index: 1000;
 overflow-y: auto;
 padding: 20px;
 }

 .modal.active {
 display: flex;
 justify-content: center;
 align-items: center;
 }

 .modal-content {
 background: white;
 border-radius: 15px;
 padding: 40px;
 max-width: 800px;
 width: 100%;
 max-height: 90vh;
 overflow-y: auto;
 position: relative;
 }

 .modal-title {
 color: #667eea;
 font-size: 2rem;
 margin-bottom: 30px;
 }

 .form-group {
 margin-bottom: 25px;
 }

 .form-label {
 display: block;
 color: #333;
 font-weight: 600;
 margin-bottom: 8px;
 font-size: 0.95rem;
 }

 .form-input,
 .form-textarea {
 width: 100%;
 padding: 12px;
 border: 2px solid #ddd;
 border-radius: 8px;
 font-size: 16px;
 font-family: inherit;
 transition: border-color 0.3s;
 }

 .form-input:focus,
 .form-textarea:focus {
 outline: none;
 border-color: #667eea;
 }

 .form-textarea {
 resize: vertical;
 min-height: 100px;
 }

 .form-checkbox {
 display: flex;
 align-items: center;
 gap: 10px;
 margin: 10px 0;
 }

 .form-checkbox input[type="checkbox"] {
 width: 20px;
 height: 20px;
 cursor: pointer;
 }

 .players-editor {
 margin-top: 20px;
 }

 .player-item {
 display: flex;
 gap: 10px;
 margin-bottom: 10px;
 align-items: center;
 }

 .player-item input {
 flex: 1;
 }

 .btn-remove {
 background: #dc3545;
 color: white;
 border: none;
 padding: 10px 15px;
 border-radius: 8px;
 cursor: pointer;
 font-weight: 600;
 }

 .btn-remove:hover {
 background: #c82333;
 }

 .modal-actions {
 display: flex;
 gap: 15px;
 margin-top: 30px;
 justify-content: flex-end;
 }

 .error-message {
 background: rgba(220, 53, 69, 0.1);
 border: 2px solid #dc3545;
 color: #dc3545;
 padding: 15px;
 border-radius: 8px;
 margin-bottom: 20px;
 }

 .success-message {
 background: rgba(40, 167, 69, 0.1);
 border: 2px solid #28a745;
 color: #28a745;
 padding: 15px;
 border-radius: 8px;
 margin-bottom: 20px;
 }

 .controls {
 display: flex;
 gap: 15px;
 flex-wrap: wrap;
 margin-bottom: 20px;
 align-items: center;
 }

 .bilingual-toggle {
 margin-left: auto;
 background: rgba(102, 126, 234, 0.1);
 padding: 10px 20px;
 border-radius: 10px;
 border: 2px solid rgba(102, 126, 234, 0.3);
 }

 .toggle-label {
 display: flex;
 align-items: center;
 gap: 10px;
 cursor: pointer;
 user-select: none;
 }

 .toggle-label input[type="checkbox"] {
 width: 20px;
 height: 20px;
 cursor: pointer;
 }

 .toggle-text {
 font-weight: 600;
 color: #667eea;
 font-size: 1rem;
 }

 .info-text {
 color: #666;
 font-size: 0.9rem;
 margin-top: 10px;
 line-height: 1.5;
 }

 .url-preview {
 background: rgba(102, 126, 234, 0.05);
 padding: 15px;
 border-radius: 8px;
 margin-top: 15px;
 border-left: 4px solid #667eea;
 }

 .url-preview strong {
 color: #667eea;
 }

 .url-preview code {
 background: rgba(0, 0, 0, 0.05);
 padding: 2px 8px;
 border-radius: 4px;
 font-family: 'Courier New', monospace;
 }

 /* Stats card global */
 .stats-card {
 background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
 color: white;
 padding: 25px;
 border-radius: 12px;
 text-align: center;
 box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
 margin-bottom: 20px;
 }

 .stats-card .stat-value {
 font-size: 48px;
 font-weight: bold;
 margin-bottom: 10px;
 color: white;
 }

 .stats-card .stat-label {
 font-size: 16px;
 opacity: 0.9;
 }

 .global-messages-card {
 background: white;
 padding: 25px;
 border-radius: 12px;
 box-shadow: 0 3px 10px rgba(0,0,0,0.1);
 }
 
        /* Design section */
        .design-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .design-card hr {
            margin: 25px 0;
            border: none;
            border-top: 1px solid #ddd;
        }

    </style>
</head>
<body>
 <!-- ========================================
 LOADING AUTH
 ======================================== -->
 <div id="authLoading">
 <div class="spinner"></div>
 <p>Vérification de l'authentification...</p>
 </div>

 <!-- ========================================
 MAIN CONTENT
 ======================================== -->
 <div id="mainContent">
 <div class="container">
 <!-- Header -->
 <div class="header">
 <h1> Administration Multi-Sondages</h1>
 <div class="user-info-container">
 <span class="user-email" id="userEmail">Chargement...</span>
 <button class="logout-btn" onclick="handleLogout()">ðŸšª Déconnexion</button>
 </div>
 </div>

 <!-- Statistiques globales -->
 <div class="section">
 <h2> Statistiques Globales</h2>
 <div class="stats-card">
 <div class="stat-value" id="totalSurveysCount">0</div>
 <div class="stat-label">Sondages créés</div>
 </div>
 </div>

 <!-- Messages globaux -->
 <div class="section">
 <h2> Messages Globaux (aucun sondage actif)</h2>
 <div class="global-messages-card">
 <p style="color: #666; margin-bottom: 20px; font-size: 0.95rem;">
 Ces messages s'affichent quand aucun sondage n'est actif. Configurez-les une seule fois pour tous les sondages.
 </p>
 
 <div class="form-group">
 <label class="form-label">Message Français</label>
 <textarea class="form-input" id="globalMessageFr" rows="3" placeholder="Le sondage est actuellement ferme. Revenez bientot !"></textarea>
 </div>

 <div class="form-group">
 <label class="form-label">Message Neerlandais</label>
 <textarea class="form-input" id="globalMessageNl" rows="3" placeholder="De enquete is momenteel gesloten. Kom snel terug!"></textarea>
 </div>

 <button class="btn btn-success" onclick="saveGlobalMessages()" style="margin-top: 10px;">
 ðŸ’¾ Enregistrer les messages
 </button>
 </div>
 </div>

 <!-- ContrÃƒÂ´les -->
 <div class="section">
 <div class="controls">
 <button class="btn btn-success" onclick="openCreateModal()">âž• Créer un sondage</button>
 <button class="btn" onclick="loadSurveys()">ðŸ”„ Actualiser</button>
 <div class="bilingual-toggle">
 <label class="toggle-label">
 <input type="checkbox" id="globalBilingualMode" onchange="toggleGlobalBilingualMode()">
 <span class="toggle-text"> Mode bilingue (FR/NL)</span>
 </label>
 </div>
 </div>
 </div>

 <!-- Liste des sondages -->
 <div class="section">
 <h2> Mes Sondages</h2>
 <div class="surveys-grid" id="surveysGrid">
 <!-- Les cartes de sondages seront insérées ici -->
 </div>
 </div>
 </div>
 </div>

 <!-- ========================================
 MODAL CREATE/EDIT SURVEY
 ======================================== -->
 <div class="modal" id="surveyModal">
 <div class="modal-content">
 <h2 class="modal-title" id="modalTitle">Créer un sondage</h2>
 
 <div id="errorContainer"></div>

 <form id="surveyForm">
 <!-- Informations de base -->
 <div class="form-group">
 <label class="form-label">Titre du sondage *</label>
 <input type="text" class="form-input" id="surveyTitle" required placeholder="Ex: Joueur préféré 2025">
 </div>

 <div class="form-group">
 <label class="form-label">Description</label>
 <textarea class="form-textarea" id="surveyDescription" placeholder="Description du sondage (optionnel)"></textarea>
 </div>

 <!-- Messages personnalisés FR -->

 <div class="form-group">
 <label class="form-label">Message remerciement (FR)</label>
 <textarea class="form-textarea" id="msgThankyouFr" placeholder="Ex: Merci pour votre vote !"></textarea>
 </div>

 <!-- Logo Upload -->
 <div class="form-group">
 <label class="form-label">Logo (PNG sur fond transparent)</label>
 <div style="display: flex; gap: 10px; margin-bottom: 10px;">
 <button type="button" class="btn" onclick="document.getElementById('logoFile').click()"> Upload Logo</button>
 <button type="button" class="btn btn-danger" onclick="resetLogo()"> Reset Logo</button>
 </div>
 <input type="file" id="logoFile" accept="image/png,image/jpeg,image/jpg" style="display: none;">
 <div id="logoPreview" style="margin-top: 10px; text-align: center; min-height: 80px; background: rgba(0,0,0,0.05); border-radius: 8px; padding: 10px; display: none;">
 <img id="logoPreviewImg" style="max-width: 100%; max-height: 150px; border-radius: 8px;">
 </div>
 </div>

 <!-- Candidats / Questions -->
 <div class="form-group">
 <label class="form-label">Candidats / Questions *</label>
 <p class="info-text">Ajoutez au moins 2 candidats/questions pour votre sondage. Si NL est activé, vous pourrez les traduire ci-dessous.</p>
 <div id="playersEditor" class="players-editor"></div>
 <button type="button" class="btn" onclick="addPlayerField()">âž• Ajouter un candidat</button>
 </div>

 <!-- Traduction NL - Toujours visible -->
 <div style="background: rgba(244, 208, 63, 0.1); padding: 20px; border-radius: 10px; border: 2px solid rgba(244, 208, 63, 0.3); margin-top: 20px;">
 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
 <h3 style="color: #f4d03f; margin: 0;"> Traduction néerlandaise</h3>
 <button type="button" class="btn" onclick="translateAllToNL()" style="background: #f39c12; color: white;">
 Ouvrir DeepL
 </button>
 </div>
 <p class="info-text" style="margin-bottom: 15px;">
 Remplissez les champs NL pour préparer la version néerlandaise. L'activation se fait via le mode bilingue global.
 </p>
 
 <div class="form-group">
 <label class="form-label">Titre (NL)</label>
 <input type="text" class="form-input" id="surveyTitleNl" placeholder="Nederlandse titel">
 </div>

 <div class="form-group">
 <label class="form-label">Description (NL)</label>
 <textarea class="form-textarea" id="surveyDescriptionNl" placeholder="Nederlandse beschrijving"></textarea>
 </div>

 <div class="form-group">
 <label class="form-label">Message remerciement (NL)</label>
 <textarea class="form-textarea" id="msgThankyouNl" placeholder="Ex: Bedankt voor je stem!"></textarea>
 </div>

 <!-- Traduction des candidats en NL -->
 <div class="form-group">
 <label class="form-label">Traduction des candidats (NL)</label>
 <p class="info-text">Traduisez chaque candidat/question en néerlandais. L'ordre correspond aux candidats FR ci-dessus.</p>
 <div id="playersEditorNL" class="players-editor"></div>
 </div>
 </div>

 <!-- Actions -->
 <div class="modal-actions">
 <button type="button" class="btn btn-danger" onclick="closeModal()">âÂÅ’ Annuler</button>
 <button type="submit" class="btn btn-success">ðŸ’¾ Enregistrer</button>
 </div>

 <!-- URLs Preview -->
 <div class="url-preview" id="urlPreview" style="display: none;">
 <p><strong>URLs du sondage :</strong></p>
 <p>FR : <code id="urlFr"></code></p>
 <p>NL : <code id="urlNl"></code></p>
 <p>Résultats : <code id="urlResults"></code></p>
 </div>
 </form>
 </div>
 </div>

 <script>
 // ============================================
 // VARIABLES GLOBALES
 // ============================================
 // VARIABLES GLOBALES
 // ============================================
 let supabaseClient = null;
 let currentUser = null;
 let allSurveys = [];
 let editingSurveyId = null;
 let currentLogoBase64 = null; // Logo en base64
 let globalBilingualMode = false; // Mode bilingue global

 // ============================================
 // AUTHENTIFICATION
 // ============================================
 async function checkAuthentication() {
 try {
 supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

 const { data: { user }, error } = await supabaseClient.auth.getUser();
 
 if (error || !user) {
 window.location.href = 'login.html';
 return false;
 }

 currentUser = user;
 document.getElementById('userEmail').textContent = user.email;
 
 document.getElementById('authLoading').style.display = 'none';
 document.getElementById('mainContent').classList.add('show');
 
 return true;
 } catch (error) {
 console.error('Erreur auth:', error);
 window.location.href = 'login.html';
 return false;
 }
 }

 async function handleLogout() {
 if (confirm('ÃƒÅ tes-vous sÃƒÂ»r de vouloir vous déconnecter ?')) {
 await supabaseClient.auth.signOut();
 window.location.href = 'login.html';
 }
 }

 // ============================================
 // CHARGEMENT DES SONDAGES
 // ============================================
 async function loadSurveys() {
 try {
 const { data: surveys, error } = await supabaseClient
 .from('surveys')
 .select(`
 *,
 survey_translations(language_code, active),
 survey_players(id)
 `)
 .order('ordre', { ascending: true });

 if (error) throw error;

 allSurveys = surveys || [];
 
 // Charger les statistiques
 const { data: stats, error: statsError } = await supabaseClient
 .from('v_survey_stats')
 .select('*');

 const statsMap = {};
 if (!statsError && stats) {
 stats.forEach(s => {
 statsMap[s.survey_id] = s;
 });
 }

 // Afficher les sondages
 displaySurveys(allSurveys, statsMap);
 
 // Mettre Ã  jour les stats globales
 document.getElementById('totalSurveysCount').textContent = allSurveys.length;

 } catch (error) {
 console.error('Erreur chargement sondages:', error);
 alert('âÂÅ’ Erreur: ' + error.message);
 }
 }

 function displaySurveys(surveys, statsMap) {
 const grid = document.getElementById('surveysGrid');
 
 if (!surveys || surveys.length === 0) {
 grid.innerHTML = '<p style="text-align: center; color: #666;">Aucun sondage créé. Cliquez sur "Créer un sondage" pour commencer.</p>';
 return;
 }

 grid.innerHTML = '';

 surveys.forEach((survey, index) => {
 const stats = statsMap[survey.id] || { total_players: 0, total_votes: 0, votes_fr: 0, votes_nl: 0 };
 const hasNL = survey.survey_translations && survey.survey_translations.length > 0;
 const nlActive = hasNL && survey.survey_translations[0].active;

 const card = document.createElement('div');
 card.className = 'survey-card' + (survey.active ? ' active' : '');
 card.innerHTML = `
 <div class="survey-order">${index + 1}</div>
 
 <div class="survey-header">
 <div class="survey-title">${escapeHtml(survey.titre)}</div>
 <span class="${survey.active ? 'active-badge' : 'inactive-badge'}">
 ${survey.active ? ' Actif' : '⚫ Inactif'}
 </span>
 </div>

 ${survey.description ? `<div class="survey-description">${escapeHtml(survey.description)}</div>` : ''}

 <div class="language-badges">
 <span class="lang-badge fr"> Français</span>
 <span class="lang-badge nl ${nlActive ? '' : 'inactive'}">
 Nederlands ${nlActive ? '✓' : '✗'}
 </span>
 </div>

 <div class="survey-stats">
 <div class="survey-stat">
 <div class="stat-value">${stats.total_players || 0}</div>
 <div class="stat-label">Choix</div>
 </div>
 <div class="survey-stat">
 <div class="stat-value">${stats.total_votes || 0}</div>
 <div class="stat-label">Votes totaux</div>
 </div>
 <div class="survey-stat">
 <div class="stat-value">${stats.votes_fr || 0}</div>
 <div class="stat-label">Votes FR</div>
 </div>
 <div class="survey-stat">
 <div class="stat-value">${stats.votes_nl || 0}</div>
 <div class="stat-label">Votes NL</div>
 </div>
 </div>

 <div class="survey-actions">
 <div style="display: flex; gap: 8px; width: 100%; align-items: center;">
 <div style="display: flex; flex-direction: column; gap: 4px;">
 <button class="btn" onclick="moveSurvey(${survey.id}, 'up')" 
 style="padding: 5px 10px; font-size: 0.8rem; min-width: auto; ${index === 0 ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
 ${index === 0 ? 'disabled' : ''}>
 â" "˜
 </button>
 <button class="btn" onclick="moveSurvey(${survey.id}, 'down')" 
 style="padding: 5px 10px; font-size: 0.8rem; min-width: auto; ${index === surveys.length - 1 ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
 ${index === surveys.length - 1 ? 'disabled' : ''}>
 â" "
 </button>
 </div>
 <button class="btn ${survey.active ? 'btn-warning' : 'btn-success'}" 
 onclick="toggleActive(${survey.id}, ${survey.active})"
 style="flex: 1; ${survey.ever_activated && !survey.active ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
 ${survey.ever_activated && !survey.active ? 'disabled' : ''}>
 ${survey.active ? 'Â Désactiver' : 'Â Activer'}
 </button>
 <button class="btn btn-done ${survey.ever_activated ? 'active' : ''}" 
 onclick="toggleEverActivated(${survey.id}, ${survey.ever_activated})"
 style="flex: 1;">
 ${survey.ever_activated ? ' DéjÃ  fait' : 'âÂ¬Å“ DéjÃ  fait'}
 </button>
 </div>
 <div style="display: flex; gap: 8px; width: 100%;">
 <button class="btn btn-info" onclick="editSurvey(${survey.id})" style="flex: 1;">Â Modifier</button>
 <button class="btn btn-warning" onclick="resetVotes(${survey.id})" style="flex: 1;">ðŸ”„ Reset votes</button>
 </div>
 <button class="btn btn-danger" onclick="deleteSurvey(${survey.id})" style="width: 100%;"> Supprimer</button>
 </div>
 `;
 grid.appendChild(card);
 });
 }

 // ============================================
 // ACTIVER/DÃƒ"°SACTIVER SONDAGE
 // ============================================
 async function toggleActive(surveyId, currentActive) {
 try {
 if (!currentActive) {
 // Désactiver tous les autres sondages de l'utilisateur
 console.log('ðŸ”„ Désactivation des autres sondages...');
 const { error: deactivateError } = await supabaseClient
 .from('surveys')
 .update({ active: false })
 .eq('user_id', currentUser.id)
 .neq('id', surveyId);
 
 if (deactivateError) {
 console.error('Erreur désactivation:', deactivateError);
 }
 }

 // Activer/désactiver le sondage actuel
 console.log('ðŸ”„ Mise Ã  jour du sondage #' + surveyId);
 const updateData = { active: !currentActive };
 
 // Si on active pour la première fois, marquer comme "ever_activated"
 if (!currentActive) {
 updateData.ever_activated = true;
 }
 
 const { error } = await supabaseClient
 .from('surveys')
 .update(updateData)
 .eq('id', surveyId)
 .eq('user_id', currentUser.id);

 if (error) throw error;

 alert(currentActive ? 'Â Sondage désactivé' : ' Sondage activé (vos autres sondages ont été désactivés)');
 await loadSurveys();

 } catch (error) {
 console.error('âÂÅ’ Erreur toggleActive:', error);
 alert('âÂÅ’ Erreur: ' + error.message);
 }
 }

 // ============================================
 // DÃƒ"°PLACER SONDAGE
 // ============================================
 async function moveSurvey(surveyId, direction) {
 try {
 // Trouver l'index du sondage actuel
 const currentIndex = allSurveys.findIndex(s => s.id === surveyId);
 if (currentIndex === -1) {
 alert('âÂÅ’ Sondage introuvable');
 return;
 }
 
 // Vérifier si le déplacement est possible
 if (direction === 'up' && currentIndex === 0) return;
 if (direction === 'down' && currentIndex === allSurveys.length - 1) return;
 
 const currentSurvey = allSurveys[currentIndex];
 const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
 const targetSurvey = allSurveys[targetIndex];
 
 // Ãƒ"°changer les ordres
 const { error: error1 } = await supabaseClient
 .from('surveys')
 .update({ ordre: targetSurvey.ordre })
 .eq('id', currentSurvey.id);
 
 if (error1) throw error1;
 
 const { error: error2 } = await supabaseClient
 .from('surveys')
 .update({ ordre: currentSurvey.ordre })
 .eq('id', targetSurvey.id);
 
 if (error2) throw error2;
 
 // Recharger les sondages
 await loadSurveys();
 
 } catch (error) {
 console.error('âÂÅ’ Erreur moveSurvey:', error);
 alert('âÂÅ’ Erreur: ' + error.message);
 }
 }

 // ============================================
 // GESTION DU LOGO
 // ============================================
 document.getElementById('logoFile').addEventListener('change', async (e) => {
 const file = e.target.files[0];
 if (!file) return;

 // Vérifier le type de fichier
 if (!file.type.startsWith('image/')) {
 alert('âÂÅ’ Veuillez sélectionner une image');
 return;
 }

 // Vérifier la taille (max 2MB)
 if (file.size > 2 * 1024 * 1024) {
 alert('âÂÅ’ L\'image est trop grande (max 2MB)');
 return;
 }

 try {
 // Convertir en base64
 const reader = new FileReader();
 reader.onload = (event) => {
 currentLogoBase64 = event.target.result;
 document.getElementById('logoPreviewImg').src = currentLogoBase64;
 document.getElementById('logoPreview').style.display = 'block';
 console.log(' Logo chargé');
 };
 reader.readAsDataURL(file);
 } catch (error) {
 console.error('Erreur upload logo:', error);
 alert('âÂÅ’ Erreur lors du chargement du logo');
 }
 });

 function resetLogo() {
 currentLogoBase64 = null;
 document.getElementById('logoFile').value = '';
 document.getElementById('logoPreview').style.display = 'none';
 document.getElementById('logoPreviewImg').src = '';
 console.log(' Logo supprimé');
 }

 // ============================================
 // SYNCHRONISATION DES CHAMPS NL
 // ============================================
 function syncNLFields() {
 const playerInputsFR = document.querySelectorAll('#playersEditor .player-item input');
 const editorNL = document.getElementById('playersEditorNL');
 
 // Sauvegarder les valeurs actuelles NL
 const currentNLValues = [];
 const currentNLInputs = editorNL.querySelectorAll('.player-item input');
 currentNLInputs.forEach(input => {
 currentNLValues.push(input.value);
 });

 // Reconstruire les champs NL
 editorNL.innerHTML = '';
 
 playerInputsFR.forEach((inputFR, index) => {
 const item = document.createElement('div');
 item.className = 'player-item';
 item.style.marginBottom = '10px';
 
 const valueFR = inputFR.value || `Candidat ${index + 1}`;
 const valueNL = currentNLValues[index] || '';
 
 item.innerHTML = `
 <div style="flex: 1;">
 <div style="font-size: 0.85em; color: #667eea; margin-bottom: 5px;">FR: ${escapeHtml(valueFR)}</div>
 <input type="text" class="form-input" placeholder="Traduction NL" value="${escapeHtml(valueNL)}" style="margin: 0;">
 </div>
 `;
 editorNL.appendChild(item);
 });
 }

 // ============================================
 // TRADUCTION AUTOMATIQUE NL - COPIER ET OUVRIR DEEPL
 // ============================================
 function translateAllToNL() {
 try {
 // Récupérer les textes FR Ã  traduire
 const titleFR = document.getElementById('surveyTitle').value.trim();
 const descriptionFR = document.getElementById('surveyDescription').value.trim();
 const thankyouFR = document.getElementById('msgThankyouFr').value.trim();
 
 // Récupérer les candidats FR
 const playerInputsFR = document.querySelectorAll('#playersEditor .player-item input');
 const playersFR = Array.from(playerInputsFR).map((input, index) => ({
 index: index + 1,
 text: input.value.trim()
 })).filter(p => p.text);

 if (!titleFR && !descriptionFR && !thankyouFR && playersFR.length === 0) {
 alert('âÅ¡Â ïÂ¸Â Veuillez remplir au moins un champ FR Ã  traduire.');
 return;
 }

 // Formater le texte pour DeepL avec des séparateurs clairs
 let textToTranslate = '';
 
 if (titleFR) {
 textToTranslate += '---TITRE---\n' + titleFR + '\n\n';
 }
 
 if (descriptionFR) {
 textToTranslate += '---DESCRIPTION---\n' + descriptionFR + '\n\n';
 }
 
 if (thankyouFR) {
 textToTranslate += '---REMERCIEMENT---\n' + thankyouFR + '\n\n';
 }
 
 if (playersFR.length > 0) {
 playersFR.forEach(player => {
 textToTranslate += `---CANDIDAT${player.index}---\n${player.text}\n\n`;
 });
 }

 // Copier dans le presse-papiers
 navigator.clipboard.writeText(textToTranslate.trim()).then(() => {
 // Ouvrir DeepL dans un nouvel onglet
 window.open('https://www.deepl.com/translator#fr/nl/', '_blank');
 
 // Afficher les instructions
 alert(' Texte copié dans le presse-papiers !\n\n' +
 ' Prochaines étapes :\n' +
 '1. DeepL s\'ouvre dans un nouvel onglet\n' +
 '2. Collez (Ctrl+V ou Cmd+V) dans le champ de gauche\n' +
 '3. Attendez la traduction automatique\n' +
 '4. Copiez toute la traduction Ã  droite\n' +
 '5. Revenez ici et collez dans les champs NL\n\n' +
 ' Gardez les séparateurs ---TITRE---, ---CANDIDAT1--- etc. pour vous repérer !');
 }).catch(err => {
 // Si le presse-papiers ne fonctionne pas, afficher le texte Ã  copier manuellement
 console.error('Erreur copie presse-papiers:', err);
 
 // Créer une zone de texte temporaire pour afficher le texte
 const textarea = document.createElement('textarea');
 textarea.value = textToTranslate.trim();
 textarea.style.position = 'fixed';
 textarea.style.top = '50%';
 textarea.style.left = '50%';
 textarea.style.transform = 'translate(-50%, -50%)';
 textarea.style.width = '80%';
 textarea.style.height = '60%';
 textarea.style.zIndex = '10000';
 textarea.style.padding = '20px';
 textarea.style.fontSize = '14px';
 textarea.style.border = '3px solid #667eea';
 textarea.style.borderRadius = '10px';
 document.body.appendChild(textarea);
 textarea.select();
 
 // Ouvrir DeepL
 window.open('https://www.deepl.com/translator#fr/nl/', '_blank');
 
 alert(' Copiez le texte ci-dessous (Ctrl+C) puis collez-le dans DeepL !\n\n' +
 'Fermez cette zone de texte en cliquant en dehors.');
 
 // Supprimer la zone après 30 secondes ou au clic
 setTimeout(() => textarea.remove(), 30000);
 document.addEventListener('click', () => textarea.remove(), { once: true });
 });

 } catch (error) {
 console.error('âÂÅ’ Erreur:', error);
 alert('âÂÅ’ Erreur:\n' + error.message);
 }
 }

 // ============================================
 // MODAL
 // ============================================
 function openCreateModal() {
 editingSurveyId = null;
 currentLogoBase64 = null;
 
 document.getElementById('modalTitle').textContent = 'Créer un sondage';
 document.getElementById('surveyForm').reset();
 document.getElementById('playersEditor').innerHTML = '';
 document.getElementById('playersEditorNL').innerHTML = '';
 document.getElementById('errorContainer').innerHTML = '';
 document.getElementById('urlPreview').style.display = 'none';
 document.getElementById('logoPreview').style.display = 'none';
 
 // Ajouter 3 champs candidats par défaut
 for (let i = 0; i < 3; i++) addPlayerField();

 document.getElementById('surveyModal').classList.add('active');
 }

 async function editSurvey(surveyId) {
 editingSurveyId = surveyId;
 currentLogoBase64 = null;
 
 const survey = allSurveys.find(s => s.id === surveyId);
 if (!survey) return;

 document.getElementById('modalTitle').textContent = 'Modifier le sondage';
 document.getElementById('surveyTitle').value = survey.titre;
 document.getElementById('surveyDescription').value = survey.description || '';
 document.getElementById('msgThankyouFr').value = survey.msg_thankyou || '';
 document.getElementById('errorContainer').innerHTML = '';
 document.getElementById('urlPreview').style.display = 'none';

 // Charger le logo
 if (survey.logo_base64) {
 currentLogoBase64 = survey.logo_base64;
 document.getElementById('logoPreviewImg').src = currentLogoBase64;
 document.getElementById('logoPreview').style.display = 'block';
 } else {
 document.getElementById('logoPreview').style.display = 'none';
 }

 // Charger les candidats
 const { data: players } = await supabaseClient
 .from('survey_players')
 .select('*')
 .eq('survey_id', surveyId)
 .order('ordre');

 document.getElementById('playersEditor').innerHTML = '';
 if (players && players.length > 0) {
 players.forEach(p => addPlayerField(p.nom));
 } else {
 addPlayerField();
 }

 // Charger la traduction NL
 const { data: translations } = await supabaseClient
 .from('survey_translations')
 .select('*')
 .eq('survey_id', surveyId)
 .eq('language_code', 'nl')
 .maybeSingle();

 // Charger les traductions NL si elles existent
 if (translations) {
 document.getElementById('surveyTitleNl').value = translations.titre || '';
 document.getElementById('surveyDescriptionNl').value = translations.description || '';
 document.getElementById('msgThankyouNl').value = translations.msg_thankyou || '';
 
 // Charger les traductions des candidats
 const { data: playerTranslations } = await supabaseClient
 .from('survey_player_translations')
 .select('player_id, nom')
 .in('player_id', players.map(p => p.id))
 .eq('language_code', 'nl');
 
 // Créer un map des traductions
 const translationMap = {};
 if (playerTranslations) {
 playerTranslations.forEach(pt => {
 translationMap[pt.player_id] = pt.nom;
 });
 }
 
 // Remplir les champs NL
 syncNLFields();
 const nlInputs = document.querySelectorAll('#playersEditorNL .player-item input');
 players.forEach((player, index) => {
 if (nlInputs[index] && translationMap[player.id]) {
 nlInputs[index].value = translationMap[player.id];
 }
 });
 }

 document.getElementById('surveyModal').classList.add('active');
 }

 function closeModal() {
 document.getElementById('surveyModal').classList.remove('active');
 }

 function addPlayerField(value = '') {
 const editor = document.getElementById('playersEditor');
 const item = document.createElement('div');
 item.className = 'player-item';
 item.innerHTML = `
 <input type="text" class="form-input" placeholder="Nom du candidat/question" value="${escapeHtml(value)}" required>
 <button type="button" class="btn-remove" onclick="removePlayerField(this)"></button>
 `;
 editor.appendChild(item);
 
 // Ajouter un listener pour synchroniser les champs NL
 const input = item.querySelector('input');
 input.addEventListener('input', () => {
 syncNLFields();
 });
 
 // Toujours synchroniser les champs NL
 syncNLFields();
 }

 function removePlayerField(button) {
 button.parentElement.remove();
 // Toujours synchroniser les champs NL
 syncNLFields();
 }

 // ============================================
 // SAUVEGARDER SONDAGE
 // ============================================
 document.getElementById('surveyForm').addEventListener('submit', async (e) => {
 e.preventDefault();
 document.getElementById('errorContainer').innerHTML = '';

 const titre = document.getElementById('surveyTitle').value.trim();
 const description = document.getElementById('surveyDescription').value.trim();
 const msgThankyouFr = document.getElementById('msgThankyouFr').value.trim();

 const playerInputs = document.querySelectorAll('#playersEditor .player-item input');
 const players = Array.from(playerInputs).map(input => input.value.trim()).filter(v => v);

 if (!titre) {
 showError('Veuillez entrer un titre');
 return;
 }

 if (players.length < 2) {
 showError('Veuillez ajouter au moins 2 candidats');
 return;
 }

 // Toujours récupérer les traductions NL des candidats (les champs sont toujours visibles)
 const nlInputs = document.querySelectorAll('#playersEditorNL .player-item input');
 const playersNL = Array.from(nlInputs).map(input => input.value.trim());

 try {
 if (editingSurveyId) {
 // ===== UPDATE =====
 const { error: updateError } = await supabaseClient
 .from('surveys')
 .update({
 titre,
 description,
 msg_thankyou: msgThankyouFr,
 logo_base64: currentLogoBase64,
 updated_at: new Date().toISOString()
 })
 .eq('id', editingSurveyId);

 if (updateError) throw updateError;

 // âÅ¡Â¡ NOUVELLE LOGIQUE : Mise Ã  jour intelligente des candidats pour préserver les votes
 // Récupérer les candidats existants
 const { data: existingPlayers, error: fetchError } = await supabaseClient
 .from('survey_players')
 .select('*')
 .eq('survey_id', editingSurveyId)
 .order('ordre', { ascending: true });

 if (fetchError) throw fetchError;

 const existingCount = existingPlayers ? existingPlayers.length : 0;
 const newCount = players.length;
 
 let insertedPlayers = [];

 // Mettre Ã  jour ou créer les candidats
 for (let i = 0; i < newCount; i++) {
 if (i < existingCount) {
 // Mettre Ã  jour le candidat existant
 const { error: updatePlayerError } = await supabaseClient
 .from('survey_players')
 .update({
 nom: players[i],
 ordre: i + 1
 })
 .eq('id', existingPlayers[i].id);
 
 if (updatePlayerError) throw updatePlayerError;
 
 // Ajouter Ã  la liste pour les traductions
 insertedPlayers.push(existingPlayers[i]);
 } else {
 // Insérer un nouveau candidat
 const { data: newPlayer, error: insertPlayerError } = await supabaseClient
 .from('survey_players')
 .insert({
 survey_id: editingSurveyId,
 nom: players[i],
 ordre: i + 1
 })
 .select()
 .single();
 
 if (insertPlayerError) throw insertPlayerError;
 insertedPlayers.push(newPlayer);
 }
 }

 // Supprimer les candidats en trop (si on a réduit le nombre)
 if (newCount < existingCount) {
 const playersToDelete = existingPlayers.slice(newCount).map(p => p.id);
 
 // Supprimer d'abord les traductions de ces candidats
 await supabaseClient
 .from('survey_player_translations')
 .delete()
 .in('player_id', playersToDelete);
 
 // Supprimer les votes de ces candidats
 await supabaseClient
 .from('votes')
 .delete()
 .in('player_id', playersToDelete);
 
 // Supprimer les candidats
 await supabaseClient
 .from('survey_players')
 .delete()
 .in('id', playersToDelete);
 }

 // Gérer la traduction NL - TOUJOURS sauvegarder les traductions si elles existent
 // Récupérer les valeurs NL des champs
 const nlTitle = document.getElementById('surveyTitleNl').value.trim();
 const nlDescription = document.getElementById('surveyDescriptionNl').value.trim();
 const nlThankyou = document.getElementById('msgThankyouNl').value.trim();
 
 // Sauvegarder si au moins un champ NL est rempli
 if (nlTitle || nlDescription || nlThankyou) {
 const nlData = {
 survey_id: editingSurveyId,
 language_code: 'nl',
 active: globalBilingualMode, // Active selon le mode bilingue global
 titre: nlTitle,
 description: nlDescription,
 msg_thankyou: nlThankyou
 };

 await supabaseClient
 .from('survey_translations')
 .upsert(nlData, { onConflict: 'survey_id,language_code' });
 
 // âÅ¡Â¡ NOUVELLE LOGIQUE : Mise Ã  jour intelligente des traductions des candidats
 // Récupérer les traductions existantes
 const { data: existingTranslations } = await supabaseClient
 .from('survey_player_translations')
 .select('*')
 .in('player_id', insertedPlayers.map(p => p.id))
 .eq('language_code', 'nl');
 
 const translationsMap = {};
 if (existingTranslations) {
 existingTranslations.forEach(t => {
 translationsMap[t.player_id] = t;
 });
 }
 
 // Mettre Ã  jour ou créer les traductions
 for (let i = 0; i < insertedPlayers.length; i++) {
 const playerId = insertedPlayers[i].id;
 const nlName = playersNL[i] ? playersNL[i].trim() : '';
 
 if (nlName) {
 // Il y a une traduction NL
 if (translationsMap[playerId]) {
 // Mettre Ã  jour la traduction existante
 await supabaseClient
 .from('survey_player_translations')
 .update({ nom: nlName })
 .eq('player_id', playerId)
 .eq('language_code', 'nl');
 } else {
 // Créer une nouvelle traduction
 await supabaseClient
 .from('survey_player_translations')
 .insert({
 player_id: playerId,
 language_code: 'nl',
 nom: nlName
 });
 }
 } else if (translationsMap[playerId]) {
 // Pas de traduction NL mais il y en avait une â" ' supprimer
 await supabaseClient
 .from('survey_player_translations')
 .delete()
 .eq('player_id', playerId)
 .eq('language_code', 'nl');
 }
 }
 } else {
 // Désactiver la traduction NL (ne supprime PAS les votes)
 await supabaseClient
 .from('survey_translations')
 .delete()
 .eq('survey_id', editingSurveyId)
 .eq('language_code', 'nl');
 
 // Supprimer les traductions des candidats
 await supabaseClient
 .from('survey_player_translations')
 .delete()
 .in('player_id', insertedPlayers.map(p => p.id))
 .eq('language_code', 'nl');
 }

 alert(' Sondage mis Ã  jour !');

 } else {
 // ===== CREATE =====
 const { data: newSurvey, error: createError } = await supabaseClient
 .from('surveys')
 .insert({
 titre,
 description,
 msg_thankyou: msgThankyouFr,
 logo_base64: currentLogoBase64,
 active: false,
 ordre: allSurveys.length + 1,
 user_id: currentUser.id
 })
 .select()
 .single();

 if (createError) throw createError;
 if (!newSurvey) throw new Error('Ãƒ"°chec de création du sondage');

 // Insérer les candidats
 const playersData = players.map((nom, index) => ({
 survey_id: newSurvey.id,
 nom,
 ordre: index + 1
 }));
 
 const { data: insertedPlayers, error: playersError } = await supabaseClient
 .from('survey_players')
 .insert(playersData)
 .select();

 if (playersError) throw playersError;

 // Gérer la traduction NL - TOUJOURS sauvegarder les traductions si elles existent
 const nlTitle = document.getElementById('surveyTitleNl').value.trim();
 const nlDescription = document.getElementById('surveyDescriptionNl').value.trim();
 const nlThankyou = document.getElementById('msgThankyouNl').value.trim();
 
 // Sauvegarder si au moins un champ NL est rempli
 if (nlTitle || nlDescription || nlThankyou) {
 const nlData = {
 survey_id: newSurvey.id,
 language_code: 'nl',
 active: globalBilingualMode, // Active selon le mode bilingue global
 titre: nlTitle,
 description: nlDescription,
 msg_thankyou: nlThankyou
 };

 await supabaseClient
 .from('survey_translations')
 .insert(nlData);
 
 // Insérer les traductions des candidats
 const playerTranslations = [];
 insertedPlayers.forEach((player, index) => {
 if (playersNL[index] && playersNL[index].trim()) {
 playerTranslations.push({
 player_id: player.id,
 language_code: 'nl',
 nom: playersNL[index].trim()
 });
 }
 });
 
 if (playerTranslations.length > 0) {
 await supabaseClient
 .from('survey_player_translations')
 .insert(playerTranslations);
 }
 }

 // Afficher les URLs
 showUrls(newSurvey.id);
 
 alert(' Sondage créé !');
 }

 closeModal();
 await loadSurveys();

 } catch (error) {
 console.error('Erreur:', error);
 showError('Erreur: ' + (error.message || 'Erreur inconnue'));
 }
 });

 function showError(message) {
 document.getElementById('errorContainer').innerHTML = `<div class="error-message">âÅ¡Â ïÂ¸Â ${message}</div>`;
 }

 function showUrls(surveyId) {
 const baseUrl = window.location.origin + window.location.pathname.replace('admin.html', '');
 document.getElementById('urlFr').textContent = `${baseUrl}survey.html?id=${surveyId}`;
 document.getElementById('urlNl').textContent = `${baseUrl}survey.html?id=${surveyId}&lang=nl`;
 document.getElementById('urlResults').textContent = `${baseUrl}results.html?id=${surveyId}`;
 document.getElementById('urlPreview').style.display = 'block';
 }

 // ============================================
 // AFFICHER LES URLs
 // ============================================
 /* FONCTION DÃƒ"°SACTIVÃƒ"°E - Bouton URLs supprimé
 function viewUrls(surveyId) {
 const baseUrl = window.location.origin + window.location.pathname.replace('admin.html', '');
 const urls = `
URLs du sondage #${surveyId} :

 Sondage FR :
${baseUrl}survey.html?id=${surveyId}

 Sondage NL :
${baseUrl}survey.html?id=${surveyId}&lang=nl

 Résultats :
${baseUrl}results.html?id=${surveyId}
 `;
 alert(urls);
 }
 */

 // ============================================
 // RESET VOTES
 // ============================================
 async function resetVotes(surveyId) {
 const survey = allSurveys.find(s => s.id === surveyId);
 if (!confirm(`Réinitialiser tous les votes pour "${survey.titre}" ?\n\nCette action est irréversible.`)) {
 return;
 }

 try {
 const { error } = await supabaseClient
 .from('votes')
 .delete()
 .eq('survey_id', surveyId);

 if (error) throw error;

 alert(' Tous les votes ont été réinitialisés !');
 await loadSurveys();

 } catch (error) {
 console.error('Erreur:', error);
 alert('âÂÅ’ Erreur: ' + error.message);
 }
 }

 // ============================================
 // SUPPRIMER SONDAGE
 // ============================================
 async function deleteSurvey(surveyId) {
 const survey = allSurveys.find(s => s.id === surveyId);
 if (!confirm(`Supprimer "${survey.titre}" ?\n\nCela supprimera tous les votes et candidats associés.\nCette action est irréversible.`)) {
 return;
 }

 try {
 // Supprimer les votes
 await supabaseClient.from('votes').delete().eq('survey_id', surveyId);
 
 // Supprimer les candidats
 await supabaseClient.from('survey_players').delete().eq('survey_id', surveyId);
 
 // Supprimer les traductions
 await supabaseClient.from('survey_translations').delete().eq('survey_id', surveyId);
 
 // Supprimer le sondage
 const { error } = await supabaseClient.from('surveys').delete().eq('id', surveyId);

 if (error) throw error;

 alert(' Sondage supprimé');
 await loadSurveys();

 } catch (error) {
 console.error('Erreur:', error);
 alert('âÂÅ’ Erreur: ' + error.message);
 }
 }

 // ============================================
 // RESET "DÃƒ"°JÃƒâ‚¬ ACTIVÃƒ"°"
 // ============================================
 async function toggleEverActivated(surveyId, currentValue) {
 const newValue = !currentValue;

 try {
 const { error } = await supabaseClient
 .from('surveys')
 .update({ ever_activated: newValue })
 .eq('id', surveyId)
 .eq('user_id', currentUser.id);

 if (error) throw error;

 await loadSurveys();

 } catch (error) {
 console.error('Erreur:', error);
 alert('âÂÅ’ Erreur: ' + error.message);
 }
 }

 // ============================================
 // UTILITAIRES
 // ============================================
 function escapeHtml(text) {
 const div = document.createElement('div');
 div.textContent = text;
 return div.innerHTML;
 }

 // ============================================
 // INITIALISATION
 // ============================================
 // ============================================
 // GLOBAL MESSAGES MANAGEMENT
 // ============================================
 async function loadGlobalMessages() {
 try {
 const { data, error } = await supabaseClient
 .from('config_messages')
 .select('end_message_fr, end_message_nl')
 .single();
 
 if (error && error.code !== 'PGRST116') {
 console.error('Erreur chargement messages globaux:', error);
 return;
 }
 
 if (data) {
 document.getElementById('globalMessageFr').value = data.end_message_fr || '';
 document.getElementById('globalMessageNl').value = data.end_message_nl || '';
 }
 } catch (error) {
 console.error('Erreur chargement messages globaux:', error);
 }
 }

 async function saveGlobalMessages() {
 const messageFr = document.getElementById('globalMessageFr').value.trim();
 const messageNl = document.getElementById('globalMessageNl').value.trim();

 if (!messageFr || !messageNl) {
 alert('Veuillez remplir les deux messages.');
 return;
 }

 try {
 // Verifier si une ligne existe deja
 const { data: existing, error: selectError } = await supabaseClient
 .from('config_messages')
 .select('id')
 .single();

 let result;
 if (existing) {
 // Update
 result = await supabaseClient
 .from('config_messages')
 .update({
 end_message_fr: messageFr,
 end_message_nl: messageNl
 })
 .eq('id', existing.id);
 } else {
 // Insert
 result = await supabaseClient
 .from('config_messages')
 .insert({
 end_message_fr: messageFr,
 end_message_nl: messageNl
 });
 }

 if (result.error) throw result.error;

 alert('Messages globaux enregistres avec succes !');
 } catch (error) {
 console.error('Erreur sauvegarde messages globaux:', error);
 alert('Erreur lors de l\'enregistrement: ' + error.message);
 }
 }

 // ============================================
 // INITIALIZATION
 // ============================================
 // ============================================
 // MODE BILINGUE GLOBAL
 // ============================================
 async function loadGlobalBilingualMode() {
 try {
 // Charger l'état du mode bilingue depuis config_messages
 const { data, error } = await supabaseClient
 .from('config_messages')
 .select('bilingual_mode')
 .maybeSingle();
 
 if (error && error.code !== 'PGRST116') {
 console.error('Erreur chargement mode bilingue:', error);
 return;
 }
 
 globalBilingualMode = data?.bilingual_mode || false;
 document.getElementById('globalBilingualMode').checked = globalBilingualMode;
 
 } catch (error) {
 console.error('Erreur chargement mode bilingue:', error);
 }
 }

 async function toggleGlobalBilingualMode() {
 const isEnabled = document.getElementById('globalBilingualMode').checked;
 globalBilingualMode = isEnabled;
 
 try {
 // Vérifier si une ligne existe déjÃ 
 const { data: existing, error: selectError } = await supabaseClient
 .from('config_messages')
 .select('id')
 .maybeSingle();

 let result;
 if (existing) {
 // Update
 result = await supabaseClient
 .from('config_messages')
 .update({ bilingual_mode: isEnabled })
 .eq('id', existing.id);
 } else {
 // Insert
 result = await supabaseClient
 .from('config_messages')
 .insert({ bilingual_mode: isEnabled });
 }

 if (result.error) throw result.error;

 // Mettre Ã  jour toutes les traductions NL existantes
 await supabaseClient
 .from('survey_translations')
 .update({ active: isEnabled })
 .eq('language_code', 'nl');

 alert(isEnabled ? 
 ' Mode bilingue activé ! Toutes les traductions NL sont maintenant actives.' : 
 'Â Mode bilingue désactivé ! Les traductions NL restent sauvegardées mais ne sont plus actives.');
 
 await loadSurveys(); // Rafraîchir l'affichage
 
 } catch (error) {
 console.error('Erreur toggle mode bilingue:', error);
 alert('âÂÅ’ Erreur: ' + error.message);
 // Revenir Ã  l'état précédent
 document.getElementById('globalBilingualMode').checked = !isEnabled;
 globalBilingualMode = !isEnabled;
 }
 }

 // ============================================
 // INITIALIZATION
 // ============================================
 (async function init() {
 const isAuthenticated = await checkAuthentication();
 if (isAuthenticated) {
 await loadGlobalBilingualMode();
 await loadSurveys();
 await loadGlobalMessages();
 }
 })();
 </script>
</body>
</html>
