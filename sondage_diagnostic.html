<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sondage – Diagnostic Supabase</title>
  <style>
    :root {{ --bg:#0b0b0e; --fg:#f5f7fb; --muted:#9aa3b2; --card:#12141a; --ok:#2ea043; --warn:#f2ad00; --err:#d73a49; }}
    html,body {{ margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; }}
    .wrap {{ max-width:900px; margin:0 auto; padding:24px; display:flex; gap:24px; }}
    .card {{ background:var(--card); border:1px solid #1f2430; border-radius:14px; padding:16px 18px; box-shadow:0 1px 0 rgba(255,255,255,.04) inset; }}
    .grow {{ flex:1; }}
    h1 {{ font-size:22px; margin:0 0 8px; }}
    h2 {{ font-size:18px; margin:16px 0 8px; color:var(--muted); }}
    .grid {{ display:grid; grid-template-columns:160px 1fr; gap:10px 12px; align-items:start; }}
    .label {{ color:var(--muted); }}
    .value {{ white-space:pre-wrap; }}
    .status {{ display:flex; align-items:center; gap:8px; font-weight:600; }}
    .pill {{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.15); }}
    .ok .pill {{ background:rgba(46,160,67,.15); color:#8ddfaa; border-color:rgba(46,160,67,.35); }}
    .err .pill {{ background:rgba(215,58,73,.15); color:#ffb2ba; border-color:rgba(215,58,73,.35); }}
    .warn .pill {{ background:rgba(242,173,0,.15); color:#ffd77a; border-color:rgba(242,173,0,.35); }}
    pre {{ margin:0; white-space:pre-wrap; word-break:break-word; }}
    .small {{ font-size:12px; color:var(--muted); }}
    .msg {{ font-size:16px; padding:10px 12px; border-radius:10px; background:#0f1117; border:1px solid #1c2230; }}
    .stack {{ display:grid; gap:8px; }}
    .hr {{ height:1px; background:#1f2430; margin:12px 0; }}
    .help li {{ margin:4px 0; }}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card grow">
      <div class="status" id="status"><span class="pill warn">en attente…</span> Diagnostic en cours</div>
      <div class="hr"></div>

      <h1 id="pageTitle">Titre par défaut (en attendant Supabase)</h1>
      <div class="stack">
        <div class="msg" id="invitationText">Texte d'invitation (par défaut) – si Supabase répond, ce bloc sera remplacé.</div>
        <div class="msg" id="thankYouText" style="display:none">Merci d'avoir voté ! (texte par défaut)</div>
        <div class="msg" id="alreadyVotedText" style="display:none">Vous avez déjà voté (texte par défaut)</div>
      </div>

      <h2>Diagnostic</h2>
      <div class="grid">
        <div class="label">Supabase URL</div><div class="value" id="dbg_url"></div>
        <div class="label">Clé anonyme</div><div class="value small" id="dbg_key"></div>
        <div class="label">Requête</div><div class="value" id="dbg_query">settings.select(key,value).in(key,[msg_*])</div>
        <div class="label">Résultat</div><div class="value"><pre id="dbg_result">—</pre></div>
        <div class="label">Erreur</div><div class="value err"><pre id="dbg_error">—</pre></div>
      </div>

      <h2>Aide si ça échoue</h2>
      <ul class="help small">
        <li>Assure-toi que <strong>RLS est désactivé</strong> (ou que la policy <code>select</code> autorise le rôle <code>anon</code>) sur la table <code>settings</code>.</li>
        <li>Vérifie que la table <code>settings</code> contient les clés : <code>msg_title</code>, <code>msg_invitation</code>, <code>msg_thankyou</code>, <code>msg_alreadyvoted</code>.</li>
        <li>Essaie un <strong>Ctrl+F5</strong> (cache).</li>
        <li>Ouvre la <strong>Console</strong> (F12) et regarde s'il y a des erreurs réseau ou CORS.</li>
      </ul>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://mtgwnqzobxvnducxpuww.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10Z3ducXpvYnh2bmR1Y3hwdXd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODM5MjQsImV4cCI6MjA3NTQ1OTkyNH0.iB6xGRvZsA5Dcjq0vTfoUB1Rhk6cW7HV4yF9-yew8DM";

    document.getElementById('dbg_url').textContent = SUPABASE_URL;
    document.getElementById('dbg_key').textContent = SUPABASE_ANON_KEY.slice(0,8) + "…";

    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function setStatus(kind, text) {{ 
      const s = document.getElementById('status');
      s.className = "status " + kind;
      s.innerHTML = '<span class="pill">' + (kind==='ok'?'connecté':'erreur') + '</span> ' + text;
    }}

    function applyTexts(map) {{ 
      const title = map['msg_title'];
      const invit = map['msg_invitation'];
      const ty = map['msg_thankyou'];
      const av = map['msg_alreadyvoted'];
      if (title) {{ document.getElementById('pageTitle').textContent = title; document.title = title; }}
      if (invit) {{ document.getElementById('invitationText').innerHTML = invit.replace(/\n/g,'<br>'); }}
      if (ty) {{ const el=document.getElementById('thankYouText'); el.style.display='block'; el.innerHTML = ty.replace(/\n/g,'<br>'); }}
      if (av) {{ const el=document.getElementById('alreadyVotedText'); el.style.display='block'; el.innerHTML = av.replace(/\n/g,'<br>'); }}
    }}

    async function run() {{ 
      try {{
        const {{ data, error }} = await client
          .from('settings')
          .select('key,value')
          .in('key', ['msg_title','msg_invitation','msg_thankyou','msg_alreadyvoted']);

        document.getElementById('dbg_result').textContent = JSON.stringify({{data, error}}, null, 2);
        if (error) {{ 
          setStatus('err', 'Erreur lors de la lecture de settings.');
          document.getElementById('dbg_error').textContent = error.message || String(error);
          console.error('Supabase error:', error);
          return;
        }}
        const map = {{}};
        (data||[]).forEach(r => {{ if (!(r.key in map)) map[r.key]=r.value; }});
        applyTexts(map);
        setStatus('ok', 'Lecture settings réussie, textes appliqués.');
        document.getElementById('dbg_error').textContent = '—';
      }} catch (e) {{
        setStatus('err', 'Exception JS pendant le fetch.');
        document.getElementById('dbg_error').textContent = (e && e.message) ? e.message : String(e);
        console.error(e);
      }}
    }}

    run();
  </script>
</body>
</html>
