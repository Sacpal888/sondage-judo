<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sondage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a1828 0%, #1a2f4a 50%, #0d2744 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }
        
        .container {
            width: 100%;
            max-width: 95%;
            background: rgba(13, 39, 68, 0.95);
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 30px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            max-height: none;
            height: auto;
            overflow: visible;
        }

        .hidden {
            display: none !important;
        }

        /* ========================================
           COOKIE CONSENT SCREEN - BILINGUAL
        ======================================== */
        .cookie-consent {
            text-align: center;
            width: 100%;
        }

        .consent-content {
            padding: 40px 30px;
            background: rgba(26, 47, 74, 0.8);
            border: 2px solid rgba(212, 175, 55, 0.5);
            border-radius: 15px;
        }

        .cookie-icon {
            font-size: 5rem;
            margin-bottom: 25px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Titres bilingues */
        .consent-title-bilingual {
            margin-bottom: 25px;
        }

        .consent-title-fr {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .consent-title-nl {
            font-size: 1.8rem;
            font-weight: bold;
            color: #f4d03f;
            margin-bottom: 5px;
        }

        /* Textes bilingues */
        .consent-text-container {
            margin-bottom: 20px;
        }

        .consent-text-fr {
            font-size: 1rem;
            color: #ffffff;
            line-height: 1.6;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #ffffff;
        }

        .consent-text-nl {
            font-size: 1rem;
            color: #f4d03f;
            line-height: 1.6;
            padding: 15px;
            background: rgba(244, 208, 63, 0.05);
            border-radius: 10px;
            border-left: 4px solid #f4d03f;
        }

        .privacy-link {
            color: #f0d46f;
            text-decoration: underline;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .privacy-link:hover {
            color: #d4af37;
        }

        /* Boutons linguistiques */
        .consent-buttons-bilingual {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }

        .language-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .btn-consent-lang {
            flex: 1;
            padding: 18px 25px;
            font-size: 1.15rem;
            font-weight: bold;
            border: 3px solid;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-consent-lang::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transition: left 0.3s ease;
        }

        .btn-consent-lang:hover::before {
            left: 100%;
        }

        /* Bouton Français (blanc) */
        .btn-accept-fr {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #ffffff;
            border-color: #ffffff;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-accept-fr:hover {
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
        }

        /* Bouton NÃ©erlandais (jaune) */
        .btn-accept-nl {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            color: #1a2f4a;
            border-color: #f4d03f;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .btn-accept-nl:hover {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.5);
        }

        .btn-decline {
            background: rgba(220, 53, 69, 0.2);
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-decline:hover {
            background: rgba(220, 53, 69, 0.4);
            border-color: #ffffff;
            transform: translateY(-2px);
        }

        .btn-back {
            background: #0066B3;
            color: #ffffff;
            border: 2px solid #ffffff;
            border-radius: 10px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: #0088cc;
            transform: translateY(-2px);
        }

        /* Indicateur de langue dans le bouton */
        .lang-flag {
            font-size: 1.3rem;
            margin-right: 8px;
        }

        /* ========================================
           PRIVACY POLICY SCREEN
        ======================================== */
        .privacy-policy {
            text-align: left;
            width: 100%;
            max-height: 70vh;
            overflow-y: auto;
        }

        .privacy-content {
            padding: 30px 20px;
        }

        .policy-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 15px;
        }

        .privacy-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 25px;
            text-align: center;
        }

        .privacy-section {
            background: rgba(26, 47, 74, 0.6);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .privacy-section h3 {
            font-size: 1.2rem;
            color: #f0d46f;
            margin-bottom: 10px;
        }

        .privacy-section p {
            font-size: 1rem;
            color: #ffffff;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .privacy-section ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .privacy-section li {
            font-size: 1rem;
            color: #ffffff;
            line-height: 1.6;
            margin-bottom: 6px;
        }

        .privacy-buttons {
            text-align: center;
            margin-top: 25px;
        }

        /* ========================================
           CONSENT DECLINED SCREEN
        ======================================== */
        .consent-declined {
            text-align: center;
            width: 100%;
        }

        .declined-content {
            padding: 40px 30px;
            background: rgba(26, 47, 74, 0.8);
            border: 2px solid rgba(212, 175, 55, 0.5);
            border-radius: 15px;
        }

        .declined-icon {
            font-size: 5rem;
            margin-bottom: 25px;
            opacity: 0.8;
        }

        .declined-title {
            font-size: 1.7rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 20px;
        }

        .declined-text {
            font-size: 1.1rem;
            color: #ffffff;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* ========================================
           LOGO
        ======================================== */
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .logo-container img {
            max-width: 250px;
            max-height: 120px;
            object-fit: contain;
        }

        /* ========================================
           MAIN SURVEY SECTION
        ======================================== */
        .page-title {
            font-size: 4rem;
            font-weight: bold;
            text-align: center;
            color: #d4af37;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            line-height: 1.2;
        }

        .invitation-text {
            font-size: 3.3rem;
            color: #ffffff;
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 0;
            width: 100%;
        }

        .player-card {
            background: linear-gradient(135deg, #1a2f4a 0%, #0d2744 100%);
            border: 3px solid rgba(212, 175, 55, 0.5);
            border-radius: 15px;
            padding: 35px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: auto;
            height: auto;
        }

        .player-card:hover {
            transform: translateY(-5px);
            border-color: #d4af37;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4);
        }

        .player-card.selected {
            background: linear-gradient(135deg, #d4af37 0%, #f0d46f 100%);
            border-color: #ffffff;
            transform: scale(1.05);
        }

        .player-card.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .player-name {
            font-size: 3.8rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 20px;
            word-wrap: break-word;
            line-height: 1.3;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .player-card.selected .player-name {
            color: #0a1828;
        }

        .vote-button {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            color: #0a1828;
            border: 2px solid #f4d03f;
            padding: 20px 25px;
            border-radius: 10px;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 50%;
            margin: 0 auto;
        }

        .vote-button:hover {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }

        .player-card.selected .vote-button {
            background: #0a1828;
            color: #f4d03f;
            border-color: #f4d03f;
        }

        /* ========================================
           THANK YOU SECTION
        ======================================== */
        .thank-you {
            display: none;
            text-align: center;
            padding: 60px 40px;
            background: rgba(26, 47, 74, 0.8);
            border: 3px solid #d4af37;
            border-radius: 20px;
            transition: all 0.5s ease;
        }

        .thank-you.show {
            display: block;
            animation: thankYouAppear 0.5s ease forwards;
        }

        @keyframes thankYouAppear {
            0% { 
                transform: scale(0.8);
                opacity: 0;
            }
            100% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        .thank-you-icon {
            font-size: 7rem;
            margin-bottom: 30px;
            animation: celebrate 1s ease;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(-10deg); }
            75% { transform: scale(1.2) rotate(10deg); }
        }

        .thank-you-title {
            font-size: 4.5rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 25px;
        }

        .thank-you-text {
            font-size: 3rem;
            color: #ffffff;
            line-height: 1.6;
        }

        /* ========================================
           LOADING & ERROR MESSAGES
        ======================================== */
        .loading-message {
            text-align: center;
            font-size: 3rem;
            color: #d4af37;
            padding: 50px;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.2);
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 30px;
            color: #ffffff;
            text-align: center;
            font-size: 2rem;
            line-height: 1.6;
        }

        /* ========================================
           GLOBAL MESSAGES (NO ACTIVE SURVEY)
        ======================================== */
        .global-messages-container {
            text-align: center;
            padding: 40px 20px;
            position: relative;
        }

        .global-message {
            font-size: 2rem;
            line-height: 1.6;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .global-message-fr {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .global-message-nl {
            color: #f4d03f;
            background: rgba(244, 208, 63, 0.05);
            border: 2px solid rgba(244, 208, 63, 0.3);
        }

        /* ========================================
           RESPONSIVE
        ======================================== */
        /* Tablettes */
        @media (max-width: 1024px) {
            .players-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .page-title {
                font-size: 4rem;
            }
            
            .invitation-text {
                font-size: 3rem;
            }
            
            .player-name {
                font-size: 3rem;
            }
            
            .vote-button {
                font-size: 1.6rem;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .container {
                padding: 25px 20px;
                max-width: 98%;
            }

            .consent-title-fr,
            .consent-title-nl {
                font-size: 1.6rem;
            }

            .consent-text-fr,
            .consent-text-nl {
                font-size: 1rem;
            }

            .language-buttons {
                flex-direction: column;
            }

            .btn-consent-lang {
                font-size: 1.1rem;
                padding: 15px 20px;
            }

            .page-title {
                font-size: 3rem;
            }

            .invitation-text {
                font-size: 2.5rem;
            }

            .players-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .player-card {
                padding: 30px 20px;
            }

            .player-name {
                font-size: 2.5rem;
            }

            .vote-button {
                font-size: 1.4rem;
                padding: 15px 20px;
                width: 60%;
            }
        }

        @media (max-width: 480px) {
            .page-title {
                font-size: 2.5rem;
            }

            .invitation-text {
                font-size: 2rem;
            }

            .player-name {
                font-size: 2rem;
            }

            .vote-button {
                font-size: 1.2rem;
                width: 70%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========================================
             BILINGUAL COOKIE CONSENT
        ======================================== -->
        <div id="cookieConsent" class="cookie-consent hidden">
            <div class="consent-content">
                <div class="cookie-icon">🍪</div>
                
                <div class="consent-title-bilingual">
                    <div class="consent-title-fr">🇫🇷 Cookies et Confidentialité</div>
                    <div class="consent-title-nl">🇳🇱 Cookies en Privacy</div>
                </div>

                <div class="consent-text-container">
                    <div class="consent-text-fr">
                        <strong>Français :</strong> Nous utilisons des cookies essentiels pour enregistrer votre vote et garantir l'intégrité de ce sondage. 
                        En cliquant sur le bouton de votre langue, vous acceptez notre utilisation des cookies et accédez au sondage dans votre langue préférée.
                        <br><br>
                        <a class="privacy-link" onclick="showPrivacyPolicy()">📄 Politique de confidentialité complète</a>
                    </div>

                    <div class="consent-text-nl">
                        <strong>Nederlands :</strong> We gebruiken essentielle cookies om uw stem te registreren en de integriteit van deze enquête te garanderen. 
                        Door op de knop van uw taal te klikken, accepteert u ons gebruik van cookies en krijgt u toegang tot de enquête in uw voorkeurtaal.
                        <br><br>
                        <a class="privacy-link" onclick="showPrivacyPolicy()">📄 Volledig privacybeleid</a>
                    </div>
                </div>

                <div class="consent-buttons-bilingual">
                    <div class="language-buttons">
                        <button class="btn-consent-lang btn-accept-fr" onclick="acceptConsent('fr')">
                            <span class="lang-flag">🇫🇷</span>
                            J'accepte (Français)
                        </button>
                        <button class="btn-consent-lang btn-accept-nl" onclick="acceptConsent('nl')">
                            <span class="lang-flag">🇳🇱</span>
                            Ik accepteer (Nederlands)
                        </button>
                    </div>
                    <button class="btn-decline" onclick="declineConsent()">
                        ❌ Je refuse / Ik weiger
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================
             PRIVACY POLICY (BILINGUAL)
        ======================================== -->
        <div id="privacyPolicy" class="privacy-policy hidden">
            <div class="privacy-content">
                <div class="policy-icon">🔒</div>
                <h2 class="privacy-title">Politique de Confidentialité / Privacybeleid</h2>

                <div class="privacy-section">
                    <h3>🇫🇷 Français - Utilisation des Cookies</h3>
                    <p>Ce sondage utilise des cookies techniques strictement nécessaires pour :</p>
                    <ul>
                        <li>Enregistrer votre consentement aux cookies</li>
                        <li>Garantir qu'une personne ne peut voter qu'une seule fois</li>
                        <li>Assurer l'intégrité et la validité des résultats du sondage</li>
                    </ul>
                    <p><strong>Durée de conservation :</strong> Les cookies expirent après 1 jour.</p>
                </div>

                <div class="privacy-section">
                    <h3>🇳🇱 Nederlands - Gebruik van Cookies</h3>
                    <p>Deze enquête gebruikt strikt noodzakelijke technische cookies om:</p>
                    <ul>
                        <li>Uw toestemming voor cookies te registreren</li>
                        <li>Ervoor te zorgen dat een persoon slechts één keer kan stemmen</li>
                        <li>De integriteit en geldigheid van de enquêteresultaten te waarborgen</li>
                    </ul>
                    <p><strong>Bewaartermijn:</strong> Cookies verlopen na 1 dag.</p>
                </div>

                <div class="privacy-section">
                    <h3>🇫🇷 Données Collectées</h3>
                    <p>Les informations suivantes sont collectÃ©es :</p>
                    <ul>
                        <li>Votre vote (candidat sélectionné)</li>
                        <li>Date et heure du vote</li>
                        <li>Langue choisie (FR ou NL)</li>
                        <li>Identifiant de session anonyme (pour Ã©viter les votes multiples)</li>
                    </ul>
                    <p><strong>Aucune donnÃ©e personnelle identifiable n'est collectÃ©e.</strong></p>
                </div>

                <div class="privacy-section">
                    <h3>🇳🇱 Verzamelde Gegevens</h3>
                    <p>De volgende informatie wordt verzameld:</p>
                    <ul>
                        <li>Uw stem (geselecteerde kandidaat)</li>
                        <li>Datum en tijd van stemming</li>
                        <li>Gekozen taal (FR of NL)</li>
                        <li>Anonieme sessie-ID (om meerdere stemmen te voorkomen)</li>
                    </ul>
                    <p><strong>Er worden geen identificeerbare persoonlijke gegevens verzameld.</strong></p>
                </div>

                <div class="privacy-section">
                    <h3>🇫🇷 Vos Droits</h3>
                    <p>Vous avez le droit de refuser l'utilisation de cookies. Dans ce cas, vous ne pourrez pas participer au sondage.</p>
                    <p>Les donnÃ©es sont stockÃ©es de maniÃ¨re sécurisée et ne sont jamais partagÃ©es avec des tiers.</p>
                </div>

                <div class="privacy-section">
                    <h3>🇳🇱 Uw Rechten</h3>
                    <p>U heeft het recht om het gebruik van cookies te weigeren. In dat geval kunt u niet deelnemen aan de enquête.</p>
                    <p>Gegevens worden veilig opgeslagen en worden nooit met derden gedeeld.</p>
                </div>

                <div class="privacy-buttons">
                    <button class="btn-back" onclick="backToConsent()">â† Retour / Terug</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             CONSENT DECLINED
        ======================================== -->
        <div id="consentDeclined" class="consent-declined hidden">
            <div class="declined-content">
                <div class="declined-icon">😔</div>
                <h2 class="declined-title">Participation Impossible / Deelname Onmogelijk</h2>
                <p class="declined-text">
                    <strong>🇫🇷 Français :</strong> Nous respectons votre choix. Malheureusement, sans accepter les cookies essentiels, nous ne pouvons pas garantir l'intégrité du sondage. Vous ne pouvez pas participer.
                </p>
                <p class="declined-text">
                    <strong>🇳🇱 Nederlands :</strong> We respecteren uw keuze. Helaas kunnen we zonder essentielle cookies de integriteit van de enquête niet garanderen. U kunt niet deelnemen.
                </p>
                <div style="margin-top: 25px;">
                    <button class="btn-back" onclick="backToConsent()">â† ReconsidÃ©rer / Heroverwegen</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             SURVEY SECTION
        ======================================== -->
        <div id="surveySection" class="hidden">
            <div id="logoContainer" class="logo-container" style="display: none;"></div>
            
            <div id="loadingMessage" class="loading-message">
                â³ Chargement du sondage...
            </div>

            <div id="voteSection" style="display: none;">
                <h1 id="pageTitle" class="page-title">Titre du sondage</h1>
                <p id="invitationText" class="invitation-text">Votez pour votre choix !</p>
                <div id="playersGrid" class="players-grid"></div>
            </div>

            <div id="thankYou" class="thank-you">
                <div class="thank-you-icon">🎉</div>
                <h2 class="thank-you-title">Merci !</h2>
                <p id="thankYouText" class="thank-you-text">Votre vote a Ã©tÃ© enregistré avec succès.</p>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <div id="globalMessagesContainer" class="global-messages-container" style="display: none;">
                <div id="globalMessageFr" class="global-message global-message-fr" style="display: none;"></div>
                <div id="globalMessageNl" class="global-message global-message-nl" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const COOKIE_CONSENT_NAME = 'onlive_cookie_consent';
        const COOKIE_VOTED_PREFIX = 'onlive_voted_';
                ⏳ Chargement du sondage...

        let supabaseClient = null;
        let currentSurveyId = null;
        let currentLanguage = 'fr'; // Default
        let hasVoted = false;
        let selectedPlayerId = null;
        let sessionId = generateSessionId();
        let isAutoDetected = false; // Indique si le sondage a Ã©tÃ© détecté automatiquement
        let activeCheckInterval = null; // Intervalle pour vÃ©rifier les changements
        let isBilingualMode = false; // Indique si le mode bilingue est activÃ©

        // ============================================
        // SESSION ID GENERATION
        // ============================================
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ============================================
        // COOKIE MANAGEMENT
        // ============================================
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // ============================================
        // URL PARAMETERS
        // ============================================
        async function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            
            try {
                // Initialiser Supabase si pas encore fait
                if (!supabaseClient) {
                    if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
                        throw new Error('Configuration Supabase manquante');
                    }
                    supabaseClient = supabase.createClient(
                        window.SUPABASE_URL,
                        window.SUPABASE_ANON_KEY
                    );
                }
                
                let surveyId;
                let autoDetected = false;
                
                if (id) {
                    // ID spÃ©cifique fourni dans l'URL
                    surveyId = parseInt(id);
                } else {
                    // Pas d'ID fourni â†’ dÃ©tecter automatiquement le sondage actif
                    console.log('ðŸ” Aucun ID fourni, recherche du sondage actif...');
                    
                    const { data: activeSurvey, error } = await supabaseClient
                        .from('surveys')
                        .select('id')
                        .eq('active', true)
                        .maybeSingle();
                    
                    if (error) throw error;
                    
                    if (!activeSurvey) {
                        await showGlobalMessages();
                        return null;
                    }
                    
                    surveyId = activeSurvey.id;
                    autoDetected = true;
                    console.log('âœ… Sondage actif détecté : ID', surveyId);
                }
                
                // Charger les informations du sondage pour rÃ©cupÃ©rer le bilingual_mode
                const { data: survey, error: surveyError } = await supabaseClient
                    .from('surveys')
                    .select('id, bilingual_mode')
                    .eq('id', surveyId)
                    .maybeSingle();
                
                if (surveyError) throw surveyError;
                
                if (!survey) {
                    showError(`âŒ Sondage #${surveyId} introuvable.<br><br>Il n'existe pas ou a Ã©tÃ© supprimÃ©.<br><br>Contactez l'administrateur.`);
                    return null;
                }
                
                currentSurveyId = surveyId;
                
                return { 
                    id: surveyId, 
                    autoDetected: autoDetected,
                    bilingualMode: survey.bilingual_mode === true
                };
                
            } catch (error) {
                console.error('Erreur lors de la rÃ©cupÃ©ration des paramÃ¨tres:', error);
                showError('Erreur: ' + error.message);
                return null;
            }
        }

        // ============================================
        // CONSENT MANAGEMENT
        // ============================================
        function adaptCookieScreenToBilingualMode() {
            console.log(`🌍 Adaptation de l'Ã©cran de cookies - Mode bilingue: ${isBilingualMode}`);
            
            if (!isBilingualMode) {
                // Mode monolingue (FR seulement)
                // Cacher les titres NL
                const titleNl = document.querySelector('.consent-title-nl');
                if (titleNl) titleNl.style.display = 'none';
                
                // Cacher les textes NL
                const textNl = document.querySelector('.consent-text-nl');
                if (textNl) textNl.style.display = 'none';
                
                // Cacher le bouton NL
                const btnNl = document.querySelector('.btn-accept-nl');
                if (btnNl) btnNl.style.display = 'none';
                
                // Ajuster le bouton FR pour prendre toute la largeur
                const btnFr = document.querySelector('.btn-accept-fr');
                if (btnFr) {
                    btnFr.style.flex = '1';
                    btnFr.innerHTML = '<span class="lang-flag">🇫🇷</span>J\'accepte';
                }
                
                // Ajuster le bouton de refus
                const btnDecline = document.querySelector('.btn-decline');
                if (btnDecline) {
                    btnDecline.textContent = 'âŒ Je refuse';
                }
                
                // Simplifier les messages dans les autres Ã©crans
                const declinedTitle = document.querySelector('.declined-title');
                if (declinedTitle) {
                    declinedTitle.textContent = 'Participation Impossible';
                }
                
                const declinedTexts = document.querySelectorAll('.declined-text');
                if (declinedTexts.length > 0) {
                    declinedTexts[0].innerHTML = '<strong>Français :</strong> Nous respectons votre choix. Malheureusement, sans accepter les cookies essentiels, nous ne pouvons pas garantir l\'intégrité du sondage. Vous ne pouvez pas participer.';
                    if (declinedTexts[1]) declinedTexts[1].style.display = 'none';
                }
                
                const btnBack = document.querySelectorAll('.btn-back');
                btnBack.forEach(btn => {
                    if (btn.textContent.includes('/')) {
                        btn.textContent = 'â† Retour';
                    }
                });
            }
            // Si bilingue, laisser tout tel quel (dÃ©jà en FR+NL)
        }
        
        function checkCookieConsent() {
            const consent = getCookie(COOKIE_CONSENT_NAME);
            
            // Adapter l'Ã©cran de cookies selon le mode bilingue
            adaptCookieScreenToBilingualMode();
            
            if (consent === 'accepted') {
                // VÃ©rifier la langue préférée sauvegardÃ©e
                const savedLang = getCookie(COOKIE_LANG_NAME);
                if (savedLang && isBilingualMode) {
                    currentLanguage = savedLang;
                } else {
                    currentLanguage = 'fr'; // Par dÃ©faut FR si mode monolingue
                }
                
                // Charger le sondage directement
                document.getElementById('cookieConsent').classList.add('hidden');
                document.getElementById('surveySection').classList.remove('hidden');
                initializeSurvey();
            } else {
                // Afficher l'Ã©cran de consentement
                document.getElementById('cookieConsent').classList.remove('hidden');
                document.getElementById('surveySection').classList.add('hidden');
            }
        }

        function acceptConsent(language) {
            console.log(`âœ“ Consentement acceptÃ© avec langue: ${language}`);
            
            // Si mode monolingue et langue NL demandÃ©e, forcer FR
            if (!isBilingualMode && language === 'nl') {
                console.log('âš ï¸ Mode monolingue, langue forcÃ©e à FR');
                language = 'fr';
            }
            
            // Sauvegarder le consentement
            setCookie(COOKIE_CONSENT_NAME, 'accepted', 365);
            
            // Sauvegarder la langue choisie
            currentLanguage = language;
            setCookie(COOKIE_LANG_NAME, language, 365);
            
            // Masquer l'Ã©cran de consentement et afficher le sondage
            document.getElementById('cookieConsent').classList.add('hidden');
            document.getElementById('surveySection').classList.remove('hidden');
            
            // Initialiser le sondage dans la langue choisie
            initializeSurvey();
        }

        function declineConsent() {
            console.log('âœ— Consentement refusÃ©');
            setCookie(COOKIE_CONSENT_NAME, 'declined', 1);
            
            document.getElementById('cookieConsent').classList.add('hidden');
            document.getElementById('consentDeclined').classList.remove('hidden');
        }

        function showPrivacyPolicy() {
            document.getElementById('cookieConsent').classList.add('hidden');
            document.getElementById('privacyPolicy').classList.remove('hidden');
        }

        function backToConsent() {
            document.getElementById('privacyPolicy').classList.add('hidden');
            document.getElementById('consentDeclined').classList.add('hidden');
            document.getElementById('cookieConsent').classList.remove('hidden');
        }

        // ============================================
        // SURVEY INITIALIZATION
        // ============================================
        async function initializeSurvey() {
            console.log(`🚀 Initialisation du sondage #${currentSurveyId} en ${currentLanguage}`);
            
            try {
                // Initialiser Supabase
                if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
                    throw new Error('Configuration Supabase manquante');
                }

                supabaseClient = supabase.createClient(
                    window.SUPABASE_URL,
                    window.SUPABASE_ANON_KEY
                );

                // Charger les donnÃ©es du sondage
                const { data: survey, error: surveyError } = await supabaseClient
                    .from('surveys')
                    .select('*')
                    .eq('id', currentSurveyId)
                    .maybeSingle();

                if (surveyError) throw surveyError;
                if (!survey) {
                    showError(`âŒ Sondage #${currentSurveyId} introuvable.<br><br>Il n'existe pas ou a Ã©tÃ© supprimÃ©.<br><br>Contactez l'administrateur.`);
                    return;
                }
                if (!survey.active) {
                    showError(`â¸ï¸ Ce sondage n'est plus actif.<br><br>Merci de votre intÃ©rÃªt !`);
                    return;
                }

                console.log('âœ“ Sondage chargÃ©:', survey);

                // Charger les messages (FR par dÃ©faut, puis NL si sélectionné)
                let messages = {
                    title: survey.titre || 'Sondage',
                    invitation: survey.description || 'Votez pour votre choix !',
                    thankyou: 'Merci pour votre vote !'
                };

                if (currentLanguage === 'nl') {
                    const { data: translation } = await supabaseClient
                        .from('survey_translations')
                        .select('*')
                        .eq('survey_id', currentSurveyId)
                        .eq('language_code', 'nl')
                        .maybeSingle();

                    if (translation && translation.active) {
                        messages = {
                            title: translation.titre || messages.title,
                            invitation: translation.description || messages.invitation,
                            thankyou: 'Bedankt voor uw stem!'
                        };
                        document.documentElement.lang = 'nl';
                    }
                }

                // Appliquer les messages
                document.getElementById('pageTitle').textContent = messages.title;
                document.title = messages.title;
                document.getElementById('invitationText').innerHTML = messages.invitation.replace(/\n/g, '<br>');
                document.getElementById('thankYouText').innerHTML = messages.thankyou.replace(/\n/g, '<br>');

                // Charger le logo
                if (survey.logo_base64) {
                    document.getElementById('logoContainer').style.display = 'flex';
                    document.getElementById('logoContainer').innerHTML = `<img src="${survey.logo_base64}" alt="Logo">`;
                } else {
                    document.getElementById('logoContainer').style.display = 'none';
                }

                // VÃ©rifier si l'utilisateur a dÃ©jà votÃ©
                const votedCookie = getCookie(COOKIE_VOTED_PREFIX + currentSurveyId);
                if (votedCookie === 'true') {
                    console.log('âœ“ Utilisateur a dÃ©jà votÃ©');
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('thankYou').classList.add('show');
                    
                    // âš¡ IMPORTANT : DÃ©marrer la vÃ©rification automatique mÃªme si l'utilisateur a dÃ©jà votÃ©
                    // pour qu'il puisse voir le nouveau sondage automatiquement
                    startActiveCheck();
                    return;
                }

                // Charger les candidats
                const { data: players, error: playersError } = await supabaseClient
                    .from('survey_players')
                    .select('*')
                    .eq('survey_id', currentSurveyId)
                    .order('ordre', { ascending: true });

                if (playersError) throw playersError;

                if (!players || players.length === 0) {
                    showError('Aucun candidat disponible pour ce sondage.');
                    return;
                }

                console.log('ðŸ“‹ Joueurs chargés:', players);
                console.log('ðŸ“‹ Premier joueur:', players[0]);
                console.log('ðŸ“‹ Structure d\'un joueur:', Object.keys(players[0]));

                // Si langue NL, charger les traductions des candidats
                let playerTranslationsMap = {};
                if (currentLanguage === 'nl') {
                    const { data: translations } = await supabaseClient
                        .from('survey_player_translations')
                        .select('player_id, nom')
                        .in('player_id', players.map(p => p.id))
                        .eq('language_code', 'nl');
                    
                    if (translations) {
                        translations.forEach(t => {
                            playerTranslationsMap[t.player_id] = t.nom;
                        });
                    }
                }

                // Afficher les candidats
                const grid = document.getElementById('playersGrid');
                grid.innerHTML = '';

                players.forEach(player => {
                    // Utiliser la traduction NL si disponible, sinon le nom FR
                    const playerName = playerTranslationsMap[player.id] || player.nom;
                    
                    const card = document.createElement('div');
                    card.className = 'player-card';
                    card.dataset.playerId = player.id;
                    card.innerHTML = `
                        <div class="player-name">${escapeHtml(playerName)}</div>
                        <button class="vote-button" onclick="confirmVote(${player.id})">âœ“ Voter</button>
                    `;
                    
                    card.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('vote-button')) {
                            selectPlayer(player.id);
                        }
                    });
                    
                    grid.appendChild(card);
                });

                // Ajuster la taille de police
                adjustFontSize();

                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('voteSection').style.display = 'block';
                
                // DÃ©marrer la vÃ©rification automatique si le sondage a Ã©tÃ© auto-détecté
                startActiveCheck();

            } catch (error) {
                console.error('Erreur chargement sondage:', error);
                showError('Erreur de chargement: ' + error.message);
            }
        }

        // ============================================
        // FONT SIZE ADJUSTMENT
        // ============================================
        function adjustFontSize() {
            const playerNames = document.querySelectorAll('.player-name');
            if (playerNames.length === 0) return;

            let maxLength = 0;
            playerNames.forEach(nameEl => {
                const length = nameEl.textContent.length;
                if (length > maxLength) {
                    maxLength = length;
                }
            });

            let fontSize;
            if (maxLength <= 15) {
                fontSize = 3.3; // Taille maximale (identique au sous-titre)
            } else if (maxLength <= 20) {
                fontSize = 3.0;
            } else if (maxLength <= 25) {
                fontSize = 2.6;
            } else if (maxLength <= 30) {
                fontSize = 2.2;
            } else if (maxLength <= 40) {
                fontSize = 1.8;
            } else {
                fontSize = 1.5;
            }

            playerNames.forEach(nameEl => {
                nameEl.style.fontSize = fontSize + 'rem';
            });

            console.log(`ðŸ” Taille de police ajustée à ${fontSize}rem pour max length: ${maxLength}`);
        }

        // ============================================
        // VOTING
        // ============================================
        function selectPlayer(playerId) {
            if (hasVoted) return;
            
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.querySelector(`[data-player-id="${playerId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                selectedPlayerId = playerId;
            }
        }
        
        async function confirmVote(playerId) {
            if (hasVoted) return;
            
            document.querySelectorAll('.player-card').forEach(card => {
                if (card.dataset.playerId != playerId) {
                    card.classList.add('disabled');
                }
            });
            
            await saveVote(playerId);
        }

        async function saveVote(playerId) {
            if (!supabaseClient) return;
            
            try {
                console.log('ðŸ“ Tentative de vote:', {
                    survey_id: currentSurveyId,
                    player_id: playerId,
                    language_code: currentLanguage,
                    session_id: sessionId
                });

                // InsÃ©rer le vote
                const { data, error: insertError } = await supabaseClient
                    .from('votes')
                    .insert({
                        survey_id: currentSurveyId,
                        player_id: playerId,
                        language_code: currentLanguage,
                        session_id: sessionId,
                        voted_at: new Date().toISOString()
                    })
                    .select();
                
                if (insertError) {
                    console.error('âŒ Erreur Supabase dÃ©taillÃ©e:', insertError);
                    console.error('Code:', insertError.code);
                    console.error('Message:', insertError.message);
                    console.error('Details:', insertError.details);
                    console.error('Hint:', insertError.hint);
                    throw insertError;
                }
                
                console.log('âœ… Vote enregistré avec succès:', data);
                
                // Set cookie pour empÃªcher les votes multiples
                setCookie(COOKIE_VOTED_PREFIX + currentSurveyId, 'true', 1);
                
                hasVoted = true;
                
                setTimeout(() => {
                    document.getElementById('voteSection').style.display = 'none';
                    document.getElementById('thankYou').classList.add('show');
                }, 800);
                
            } catch (error) {
                console.error('âŒ Erreur lors du vote:', error);
                
                // Message d'erreur plus dÃ©taillÃ©
                let errorMessage = 'Erreur lors de l\'enregistrement de votre vote.';
                if (error.message) {
                    errorMessage += '\n\nDÃ©tails: ' + error.message;
                }
                if (error.hint) {
                    errorMessage += '\n\nSuggestion: ' + error.hint;
                }
                errorMessage += '\n\nVeuillez contacter l\'administrateur ou vÃ©rifier la console (F12) pour plus de dÃ©tails.';
                
                alert(errorMessage);
                
                document.querySelectorAll('.player-card').forEach(card => {
                    card.classList.remove('disabled');
                });
            }
        }

        // ============================================
        // AUTO-REFRESH ACTIVE SURVEY CHECK
        // ============================================
        async function checkActiveSurveyChange() {
            if (!isAutoDetected || !supabaseClient || !currentSurveyId) return;
            
            try {
                const { data: activeSurvey, error } = await supabaseClient
                    .from('surveys')
                    .select('id')
                    .eq('active', true)
                    .maybeSingle();
                
                if (error) {
                    console.error('Erreur vÃ©rification sondage actif:', error);
                    return;
                }
                
                // Si aucun sondage actif, ou si l'ID actif est diffÃ©rent
                if (!activeSurvey || activeSurvey.id !== currentSurveyId) {
                    console.log('ðŸ”„ Changement de sondage actif détecté, rechargement...');
                    stopActiveCheck();
                    window.location.reload();
                }
            } catch (error) {
                console.error('Erreur lors de la vÃ©rification:', error);
            }
        }
        
        function startActiveCheck() {
            if (isAutoDetected && !activeCheckInterval) {
                console.log('▶️ DÃ©marrage de la vÃ©rification automatique (toutes les 2s)');
                activeCheckInterval = setInterval(checkActiveSurveyChange, 2000); // VÃ©rifier toutes les 2 secondes
            }
        }
        
        function stopActiveCheck() {
            if (activeCheckInterval) {
                console.log('â¹ï¸ ArrÃªt de la vÃ©rification automatique');
                clearInterval(activeCheckInterval);
                activeCheckInterval = null;
            }
        }

        // ============================================
        // ============================================
        // GLOBAL MESSAGES (NO ACTIVE SURVEY)
        // ============================================
        async function showGlobalMessages() {
            try {
                // Charger les messages globaux depuis Supabase
                const { data, error } = await supabaseClient
                    .from('global_messages')
                    .select('*')
                    .limit(1)
                    .maybeSingle();

                if (error) {
                    console.error('Erreur chargement messages globaux:', error);
                    showError('Aucun sondage actif pour le moment.');
                    return;
                }

                // Masquer les sections de chargement et vote
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('voteSection').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';

                const containerGlobal = document.getElementById('globalMessagesContainer');
                const messageFrEl = document.getElementById('globalMessageFr');
                const messageNlEl = document.getElementById('globalMessageNl');

                // Afficher les messages s'ils existent
                if (data) {
                    let hasMessage = false;

                    if (data.message_fr && data.message_fr.trim()) {
                        messageFrEl.textContent = data.message_fr.trim();
                        messageFrEl.style.display = 'block';
                        hasMessage = true;
                    } else {
                        messageFrEl.style.display = 'none';
                    }

                    if (data.message_nl && data.message_nl.trim()) {
                        messageNlEl.textContent = data.message_nl.trim();
                        messageNlEl.style.display = 'block';
                        hasMessage = true;
                    } else {
                        messageNlEl.style.display = 'none';
                    }

                    if (hasMessage) {
                        containerGlobal.style.display = 'block';
                    } else {
                        // Aucun message configuré -> message par défaut
                        showError('Aucun sondage actif pour le moment.');
                    }
                } else {
                    // Aucun message configuré -> message par défaut
                    showError('Aucun sondage actif pour le moment.');
                }

            } catch (error) {
                console.error('Erreur:', error);
                showError('Aucun sondage actif pour le moment.');
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('voteSection').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = await getUrlParams();
            if (urlParams) {
                isAutoDetected = urlParams.autoDetected;
                isBilingualMode = urlParams.bilingualMode;
                console.log(`ðŸ“‹ Sondage #${currentSurveyId} - Bilingue: ${isBilingualMode}, Auto-détecté: ${isAutoDetected}`);
                checkCookieConsent();
            }
        });
    </script>
</body>
</html>
