<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, height=1080">
  <title>R√©sultats - Top 6</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <style>
    :root { --scale: 0.85; } /* ‚âà 15% plus petit */
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      width:1920px;height:1080px;background:transparent;display:flex;justify-content:center;align-items:center;
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;overflow:hidden
    }
    .container{
      width:1200px;height:800px;background:linear-gradient(135deg,#0a1828 0%,#1a2f4a 50%,#0d2744 100%);
      border:5px solid #d4af37;border-radius:25px;padding:32px;box-shadow:0 20px 60px rgba(0,0,0,0.8);
      display:flex;flex-direction:column;overflow:hidden
    }
    .header{text-align:center;margin-bottom:14px}
    h1{color:#d4af37;font-size:calc(2.3em * var(--scale));margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,0.5)}
    .subtitle{color:#f0d46f;font-size:calc(1.05em * var(--scale))}
    .top-row{display:grid;grid-template-columns:2fr 1fr 1fr;gap:16px;margin:16px 8px 10px 8px}
    .stat-box,.logo-container{
      background:rgba(26,47,74,0.6);border:2px solid #d4af37;border-radius:14px;display:flex;justify-content:center;align-items:center;
      height:calc(110px * var(--scale));padding:12px
    }
    .logo-container img{max-width:100%;max-height:calc(88px * var(--scale));border-radius:8px;object-fit:contain}
    .stat-number{font-size:calc(2.2em * var(--scale));color:#d4af37;font-weight:700;line-height:1}
    .stat-label{color:#fff;margin-top:6px;font-size:calc(0.9em * var(--scale))}
    /* Zone r√©sultats : marges internes pour ne pas coller au cadre */
    .results-wrap{display:grid;grid-template-columns:1fr 1fr;gap:26px;padding:12px 28px 18px 28px;flex:1;align-items:start}
    .col{display:flex;flex-direction:column;gap:14px}
    .player-result{
      background:rgba(26,47,74,0.6);border:2px solid #d4af37;border-radius:12px;padding:calc(12px * var(--scale));
      transition:all .25s;display:flex;flex-direction:column;gap:calc(8px * var(--scale))
    }
    .player-result:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(212,175,55,0.28)}
    .player-header{display:flex;justify-content:space-between;align-items:center;gap:calc(8px * var(--scale))}
    .player-name-container{display:flex;align-items:center;gap:calc(8px * var(--scale));flex:1;min-width:0}
    .rank-badge{
      background:linear-gradient(135deg,#d4af37,#f0d46f);color:#0a1828;width:calc(32px * var(--scale));height:calc(32px * var(--scale));
      border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:calc(1em * var(--scale));flex-shrink:0
    }
    .player-name{color:#fff;font-size:calc(1em * var(--scale));font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .player-stats{text-align:right;flex-shrink:0}
    .vote-count{color:#f0d46f;font-size:calc(.85em * var(--scale));margin-bottom:2px}
    .percentage{color:#d4af37;font-size:calc(1.25em * var(--scale));font-weight:700}
    .progress-bar-container{background:rgba(10,24,40,0.7);border-radius:8px;height:calc(14px * var(--scale));overflow:hidden;border:1px solid rgba(212,175,55,.28)}
    .progress-bar{height:100%;background:linear-gradient(90deg,#d4af37,#f0d46f);border-radius:8px;transition:width .8s ease;box-shadow:0 0 10px rgba(212,175,55,.45)}
    .no-votes{text-align:center;color:#fff;padding:24px;font-size:calc(1.05em * var(--scale));grid-column:1 / -1}
    .loading{text-align:center;color:#f0d46f;padding:24px;font-size:calc(1.05em * var(--scale))}
    .error-message{
      background:rgba(220,53,69,.2);border:2px solid #dc3545;color:#ff6b6b;padding:14px;border-radius:10px;text-align:center;margin-top:8px
    }
    .debug{margin-top:8px;color:#f0d46f;font-size:12px;white-space:pre-wrap;max-height:140px;overflow:auto}
    .badge{display:inline-block;font-size:11px;color:#0a1828;background:#f0d46f;border-radius:10px;padding:2px 8px;margin-left:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="resultsTitle">üèÜ R√©sultats du Vote üèÜ</h1>
      <p class="subtitle" id="resultsSubtitle">Coupe virtuelle du public <span id="modeBadge" class="badge" style="display:none;">mode d√©grad√©</span></p>
    </div>

    <div id="loadingMessage" class="loading">‚è≥ Chargement des r√©sultats...</div>

    <div id="mainContent" style="display:none;flex-direction:column;flex:1;">
      <div class="top-row">
        <div class="logo-container" id="logoContainer"><div style="color:#999;font-style:italic;font-size:12px">Logo</div></div>
        <div class="stat-box">
          <div style="display:flex;flex-direction:column;align-items:center;">
            <div class="stat-number" id="totalVotes">0</div>
            <div class="stat-label">Votes totaux</div>
          </div>
        </div>
        <div class="stat-box">
          <div style="display:flex;flex-direction:column;align-items:center;">
            <div class="stat-number" id="totalPlayers">0</div>
            <div class="stat-label">Candidats</div>
          </div>
        </div>
      </div>

      <!-- R√©sultats : 2 colonnes (1-3 √† gauche, 4-6 √† droite) -->
      <div class="results-wrap" id="resultsWrap">
        <div class="no-votes">Aucun vote pour le moment... ü•ã</div>
      </div>
    </div>

    <div id="errorMessage" class="error-message" style="display:none;"></div>
    <div id="debug" class="debug"></div>
  </div>

  <script>
    let supabaseClient;

    function log(msg){ console.log('[Top6]', msg); const d=document.getElementById('debug'); d.textContent += (typeof msg==='string'?msg:JSON.stringify(msg))+'\\n'; }
    function showError(message){
      document.getElementById('loadingMessage').style.display='none';
      document.getElementById('mainContent').style.display='none';
      const el = document.getElementById('errorMessage'); el.textContent = message; el.style.display='block'; log('ERROR: '+message);
    }
    function showMain(){ document.getElementById('loadingMessage').style.display='none'; document.getElementById('mainContent').style.display='flex'; }

    function card(r, rank){ return `
      <div class="player-result">
        <div class="player-header">
          <div class="player-name-container">
            <div class="rank-badge">${rank}</div>
            <div class="player-name">${r.name}</div>
          </div>
          <div class="player-stats">
            <div class="vote-count">${r.votes} vote${r.votes>1?'s':''}</div>
            <div class="percentage">${r.percentage}%</div>
          </div>
        </div>
        <div class="progress-bar-container"><div class="progress-bar" style="width:${r.percentage}%"></div></div>
      </div>`; }

    function renderResults(results, totals){
      const wrap = document.getElementById('resultsWrap');
      if (!results || results.length===0 || !totals.totalVotes){
        wrap.innerHTML = '<div class="no-votes">Aucun vote pour le moment... ü•ã</div>';
        return;
      }
      const left = results.slice(0,3);
      const right = results.slice(3,6);
      const leftHtml = left.map((r,i)=>card(r, i+1)).join('');
      const rightHtml = right.map((r,i)=>card(r, i+4)).join('');
      wrap.innerHTML = `<div class="col">${leftHtml}</div><div class="col">${rightHtml}</div>`;
      document.getElementById('totalVotes').textContent = totals.totalVotes;
      document.getElementById('totalPlayers').textContent = totals.totalPlayers;
    }

    function computeResults(players, votes){
      const counts = {}; let total = 0;
      (votes||[]).forEach(v=>{ counts[v.player_id]=(counts[v.player_id]||0)+1; total++; });
      const results = (players||[]).map(p=>{
        const v = counts[p.id]||0; return { id:p.id, name:p.name, votes:v, percentage: total?((v/total)*100).toFixed(1):0 };
      }).sort((a,b)=>b.votes-a.votes).slice(0,6);
      return { results, totals:{ totalVotes: total, totalPlayers: players.length } };
    }

    async function trySupabase(){
      try{
        if (typeof window.supabase === 'undefined') throw new Error('Supabase CDN introuvable');
        if (typeof SUPABASE_URL === 'undefined' || typeof SUPABASE_ANON_KEY === 'undefined') throw new Error('config.js manquant ou incomplet');
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const [{ data: players, error: pe }, { data: votes, error: ve }] = await Promise.all([
          supabaseClient.from('players').select('*').order('name', { ascending:true }),
          supabaseClient.from('votes').select('*')
        ]);
        if (pe) throw pe; if (ve) throw ve;
        log('Donn√©es Supabase OK');
        return { players, votes };
      }catch(e){
        log('Supabase KO: '+ (e.message||e));
        return null;
      }
    }

    async function load(){
      try{
        const data = await trySupabase();
        showMain();
        if (data){
          const { results, totals } = computeResults(data.players, data.votes);
          renderResults(results, totals);
          document.getElementById('modeBadge').style.display='none';
        }else{
          // Mode d√©grad√© : jeu de donn√©es factice pour valider DESIGN/MISE EN PAGE
          document.getElementById('modeBadge').style.display='inline-block';
          const demoPlayers = [
            {id:1,name:'Candidat A'},{id:2,name:'Candidat B'},{id:3,name:'Candidat C'},
            {id:4,name:'Candidat D'},{id:5,name:'Candidat E'},{id:6,name:'Candidat F'}
          ];
          const demoVotes = [
            {player_id:1},{player_id:1},{player_id:2},{player_id:3},{player_id:1},{player_id:4},
            {player_id:2},{player_id:5},{player_id:6},{player_id:2},{player_id:3}
          ];
          const { results, totals } = computeResults(demoPlayers, demoVotes);
          renderResults(results, totals);
          showError('Mode d√©grad√© : v√©rifiez config.js, CORS/RLS ou la connexion Supabase.');
        }
      }catch(e){
        showError('Erreur inattendue: '+ (e.message||e));
      }
    }

    window.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
