<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Résultats — Top 6</title>
  <style>
    /* Overlay transparent, taille inchangée supposée 1080x1920 ou similaire */
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #fff;
      overflow: hidden;
    }

    .frame {
      /* Cadre général : ajustez si besoin à votre scène OBS/Tricaster */
      position: absolute;
      inset: 0;
      padding: 24px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .title {
      font-size: 48px;             /* Titre grand */
      font-weight: 800;
      line-height: 1.1;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      text-shadow: 0 4px 18px rgba(0,0,0,0.35);
    }

    .columns {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr; /* Deux colonnes */
      gap: 20px;
      align-items: start;
    }

    .col {
      display: grid;
      grid-template-rows: repeat(3, minmax(0, 1fr)); /* 3 lignes par colonne */
      gap: 16px;
    }

    .card {
      /* Cases 15% plus petites par rapport à une version précédente “plein cadre” */
      display: grid;
      grid-template-columns: 84px 1fr auto;
      align-items: center;
      gap: 16px;
      padding: 16px 18px;
      border-radius: 18px;
      background: rgba(10, 12, 22, 0.55); /* translucide */
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.08);
      min-height: 86px;
    }

    .rank {
      font-size: 38px;     /* Rang très lisible */
      font-weight: 900;
      opacity: 0.95;
    }

    .name {
      /* Noms aussi grands que le titre (selon votre demande passée) */
      font-size: 48px;
      font-weight: 800;
      line-height: 1.05;
      letter-spacing: 0.2px;
      text-shadow: 0 3px 14px rgba(0,0,0,0.28);
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .score {
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 120px;
    }

    .votes {
      font-size: 24px;
      font-weight: 700;
      opacity: 0.95;
    }

    .pct {
      font-size: 18px;
      font-weight: 600;
      opacity: 0.8;
    }

    .muted {
      opacity: 0.6;
      font-weight: 600;
    }

    .status {
      position: absolute;
      right: 20px;
      bottom: 18px;
      font-size: 14px;
      opacity: 0.6;
    }

    .hidden { display: none; }
    .error  { color: #ffb4b4; }
  </style>
</head>
<body>
  <div class="frame">
    <div class="title">Classement — Top 6</div>

    <div class="columns">
      <div id="col-left" class="col"></div>
      <div id="col-right" class="col"></div>
    </div>

    <div id="status" class="status muted">Chargement…</div>
  </div>

  <!-- Votre config Supabase (variables globales SUPABASE_URL / SUPABASE_ANON_KEY) -->
  <script src="./config.js"></script>
  <!-- SDK Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" integrity="sha384-xwNq3c2Lfx6xg2l9u4o3sZ3qk8uN0z0LJ1Qd1q4Hq0Qq9fF+0w0hJzZkRyQW8J9X" crossorigin="anonymous"></script>

  <script>
    // --- Client Supabase ---
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- DOM refs ---
    const colLeft  = document.getElementById('col-left');
    const colRight = document.getElementById('col-right');
    const statusEl = document.getElementById('status');

    // Rendu d’une carte
    function renderCard(entry) {
      const wrap  = document.createElement('div');
      wrap.className = 'card';

      const rankEl = document.createElement('div');
      rankEl.className = 'rank';
      rankEl.textContent = `#${entry.rank}`;

      const nameEl = document.createElement('div');
      nameEl.className = 'name';
      nameEl.textContent = entry.name ?? `Joueur ${entry.player_id}`;

      const scoreEl = document.createElement('div');
      scoreEl.className = 'score';
      const votesEl = document.createElement('div');
      votesEl.className  = 'votes';
      votesEl.textContent = `${entry.votes} vote${entry.votes > 1 ? 's' : ''}`;
      const pctEl = document.createElement('div');
      pctEl.className = 'pct';
      pctEl.textContent = `${Number(entry.percentage ?? 0).toFixed(1)} %`;

      scoreEl.appendChild(votesEl);
      scoreEl.appendChild(pctEl);

      wrap.appendChild(rankEl);
      wrap.appendChild(nameEl);
      wrap.appendChild(scoreEl);

      return wrap;
    }

    // Répartit les 6 entrées : 1–3 à gauche, 4–6 à droite
    function renderGrid(data) {
      colLeft.innerHTML  = '';
      colRight.innerHTML = '';

      const left  = data.slice(0, 3);
      const right = data.slice(3, 6);

      left.forEach(entry  => colLeft.appendChild(renderCard(entry)));
      right.forEach(entry => colRight.appendChild(renderCard(entry)));
    }

    // Appel RPC
    async function fetchTop6() {
      const { data, error } = await supabaseClient.rpc('get_top_results', { limit_n: 6 });
      if (error) throw error;
      return data ?? [];
    }

    // Boucle de rafraîchissement (polling)
    let refreshMs = 5000;        // 5s par défaut
    const refreshMin = 3000;
    const refreshMax = 15000;

    async function refreshLoop() {
      try {
        statusEl.textContent = 'Mise à jour…';
        const top6 = await fetchTop6();
        renderGrid(top6);
        statusEl.textContent = `Dernière mise à jour : ${new Date().toLocaleTimeString()}`;
        // Succès : on revient à un intervalle normal
        refreshMs = Math.max(refreshMin, 5000);
      } catch (e) {
        console.error('Erreur RPC get_top_results:', e);
        statusEl.textContent = 'Erreur de connexion. Nouvelle tentative…';
        // Backoff simple
        refreshMs = Math.min(refreshMax, Math.round(refreshMs * 1.7));
      } finally {
        setTimeout(refreshLoop, refreshMs);
      }
    }

    // Démarrage
    (async function init() {
      try {
        statusEl.textContent = 'Chargement…';
        const top6 = await fetchTop6();
        renderGrid(top6);
        statusEl.textContent = `Dernière mise à jour : ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Impossible de charger les résultats.';
      } finally {
        setTimeout(refreshLoop, refreshMs);
      }
    })();
  </script>
</body>
</html>
